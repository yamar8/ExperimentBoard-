<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול לוח ניסויים</title>
    <!-- טעינת Tailwind CSS דרך CDN לעיצוב מודרני ורספונסיבי -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת גופן Inter כברירת מחדל */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* סגנונות כלליים לטבלה ולגלילה */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch; /* גלילה חלקה במכשירים ניידים */
        }
        /* סגנון לכותרות הטבלה הנצמדות */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10; /* ודא שהכותרות נמצאות מעל תוכן הטבלה בגלילה */
        }
        /* סגנון לעמודה הראשונה הנצמדת (שם ניסוי) */
        tbody td:first-child,
        thead th:first-child {
            position: sticky;
            right: 0;
            z-index: 1; /* ודא שהעמודה הראשונה נמצאת מעל שאר התאים בגלילה אופקית */
            background-color: inherit; /* ירושה של צבע הרקע מהשורה/טבלה */
        }
        /* תיקון צל לעמודה הראשונה כאשר היא נצמדת */
        tbody td:first-child {
            box-shadow: -2px 0 5px -2px rgba(0, 0, 0, 0.1); /* צל קטן בצד שמאל */
        }
        /* סגנון מיוחד למצב כהה */
        .dark tbody td:first-child {
            box-shadow: -2px 0 5px -2px rgba(255, 255, 255, 0.1);
        }
        /* סגנון למצב עריכה מיוחד */
        .special-edit-mode-active {
            border: 2px dashed #ef4444; /* אדום מקווקו */
            padding: 5px;
            border-radius: 8px;
        }
        /* הסתרת סרגל גלילה עבור אלמנטים ספציפיים */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <!-- טעינת React ו-ReactDOM דרך CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- טעינת Babel לטרנספילציית JSX בדפדפן (לצורך פיתוח/דוגמאות בלבד, לא לייצור) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <div id="root">
        <!-- כאן אפליקציית ה-React תיטען -->
    </div>

    <script type="text/babel">
        // Helper function to get ISO week number
        const getISOWeekNumber = (d) => {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // (0 = Sunday, 1 = Monday etc.)
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            const yearStart = new Date(Date.UTC(d.getFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        };

        // Generic Confirmation Modal Component
        const ConfirmationModal = ({ show, onClose, onConfirm, title, message, darkMode }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-sm
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">{title}</h2>
                        <p className="mb-4 text-sm">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                ביטול
                            </button>
                            <button
                                onClick={onConfirm}
                                className={`px-4 py-2 rounded-lg shadow-md bg-red-500 hover:bg-red-600 text-white`}
                            >
                                אישור
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Component for displaying LLM generated summaries
        const SummaryModal = ({ show, onClose, title, content, darkMode, aiResponseStyle = {} }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">{title}</h2>
                        <div
                            className="whitespace-pre-wrap mb-4 max-h-[70vh] overflow-y-auto no-scrollbar"
                            style={{ fontSize: aiResponseStyle.fontSize, color: aiResponseStyle.textColor }}
                        >
                            {content}
                        </div>
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                סגור
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Component for Monthly Summary Modal
        const MonthlySummaryModal = ({ show, onClose, onGenerate, summaryContent, isGenerating, darkMode, aiResponseStyle = {} }) => {
            const [selectedMonth, setSelectedMonth] = React.useState('');
            const currentYear = new Date().getFullYear();
            const months = Array.from({ length: 12 }, (_, i) => new Date(currentYear, i, 1));

            React.useEffect(() => {
                // Set default to current month if not already set
                if (!selectedMonth) {
                    const today = new Date();
                    setSelectedMonth(`${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`);
                }
            }, [selectedMonth]);

            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">סיכום משימות חודשי</h2>
                        <div className="mb-4 flex flex-col sm:flex-row items-center gap-2">
                            <label htmlFor="monthSelector" className="text-sm font-medium">בחר חודש:</label>
                            <input
                                type="month"
                                id="monthSelector"
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className={`p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            />
                            <button
                                onClick={() => onGenerate(selectedMonth)}
                                disabled={isGenerating || !selectedMonth}
                                className={`px-4 py-2 rounded-lg shadow-md flex items-center justify-center gap-1 w-full sm:w-auto
                                    ${isGenerating || !selectedMonth ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}
                                    transition-colors duration-200`}
                            >
                                {isGenerating ? 'יוצר...' : 'צור סיכום'}
                            </button>
                        </div>
                        {summaryContent && (
                            <div
                                className={`mt-4 p-3 rounded-md border ${darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'} whitespace-pre-wrap max-h-[50vh] overflow-y-auto no-scrollbar`}
                                style={{ fontSize: aiResponseStyle.fontSize, color: aiResponseStyle.textColor }}
                            >
                                {summaryContent}
                            </div>
                        )}
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                סגור
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Component for Weekly Tasks Modal
        const WeeklyTasksModal = ({ show, onClose, tasks, darkMode, callGeminiAPI, taskStatusOptions, aiResponseStyle = {} }) => {
            const [weeklyAiPrompt, setWeeklyAiPrompt] = React.useState('');
            const [weeklyAiResponse, setWeeklyAiResponse] = React.useState('');
            const [isGeneratingWeeklyAi, setIsGeneratingWeeklyAi] = React.useState(false);

            React.useEffect(() => {
                // Clear AI response when modal opens/closes or tasks change
                setWeeklyAiPrompt('');
                setWeeklyAiResponse('');
                setIsGeneratingWeeklyAi(false);
            }, [show, tasks]);


            const handleGenerateWeeklyAi = async () => {
                if (!weeklyAiPrompt.trim()) {
                    alert('אנא הזן בקשה עבור ה-AI.');
                    return;
                }
                setIsGeneratingWeeklyAi(true);

                let weeklyTasksText = `משימות לשבוע הנוכחי, מקובצות לפי ניסויים:\n\n`;
                Object.entries(tasks).forEach(([expName, expTasks]) => {
                    weeklyTasksText += `ניסוי: ${expName}\n`;
                    expTasks.forEach(task => {
                        const statusLabel = taskStatusOptions.find(opt => opt.value === task.status)?.label || 'רגיל';
                        const completionStatus = task.completed ? ' (בוצע)' : ' (לא בוצע)';
                        weeklyTasksText += `- ${task.title}: ${task.description} [סטטוס: ${statusLabel}${completionStatus}] [תגיות: ${task.tags ? task.tags.join(', ') : 'אין'}]\n`;
                    });
                    weeklyTasksText += '\n';
                });

                // Add formulation instructions to the prompt
                const formulationInstructions = [];
                if (aiResponseStyle.formulationStyle && aiResponseStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${aiResponseStyle.formulationStyle}.`);
                }
                if (aiResponseStyle.generalInstructions && aiResponseStyle.generalInstructions.trim()) {
                    formulationInstructions.push(aiResponseStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';


                const prompt = `${formulationPrefix}בהתבסס על רשימת המשימות השבועיות הבאה, אנא השב לבקשה: "${weeklyAiPrompt}". השב בעברית.\n\n${weeklyTasksText}`;
                const response = await callGeminiAPI(prompt);
                setWeeklyAiResponse(response);
                setIsGeneratingWeeklyAi(false);
            };

            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">משימות לשבוע הנוכחי</h2>
                        <div className="mb-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                            {Object.keys(tasks).length === 0 ? (
                                <p className="text-gray-500 dark:text-gray-400">אין משימות לשבוע זה.</p>
                            ) : (
                                Object.entries(tasks).map(([expName, expTasks]) => (
                                    <div key={expName} className="mb-4 last:mb-0">
                                        <h3 className={`text-lg font-semibold mb-2 ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                                            {expName}
                                        </h3>
                                        <ul className="space-y-2">
                                            {expTasks.map((task, index) => (
                                                <li key={task.id || index} className={`p-2 rounded-md ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} shadow-sm`}>
                                                    <span className="font-semibold">{task.title}</span> - {task.description}
                                                    <span className={`text-xs ml-2 px-2 py-0.5 rounded-full ${task.completed ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>
                                                        {task.completed ? 'בוצע' : 'לא בוצע'}
                                                    </span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ))
                            )}
                            {/* AI section for weekly tasks */}
                            <div className="mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
                                <h3 className="text-md font-semibold mb-2">בקשה ל-AI לגבי משימות השבוע:</h3>
                                <textarea
                                    rows="3"
                                    value={weeklyAiPrompt}
                                    onChange={(e) => setWeeklyAiPrompt(e.target.value)}
                                    placeholder="בקש מה-AI לסכם, לסדר מחדש או לנתח את המשימות השבועיות..."
                                    className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                        ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                ></textarea>
                                <button
                                    onClick={handleGenerateWeeklyAi}
                                    disabled={isGeneratingWeeklyAi || !weeklyAiPrompt.trim()}
                                    className={`px-4 py-2 rounded-lg shadow-md text-sm mt-2 flex items-center justify-center gap-1
                                        ${(isGeneratingWeeklyAi || !weeklyAiPrompt.trim()) ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}
                                        transition-colors duration-200`}
                                >
                                    {isGeneratingWeeklyAi ? 'יוצר...' : '✨ בקש מה-AI'}
                                </button>
                                {weeklyAiResponse && (
                                    <div
                                        className={`mt-4 p-3 rounded-md border ${darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'} whitespace-pre-wrap`}
                                        style={{ fontSize: aiResponseStyle.fontSize, color: aiResponseStyle.textColor }}
                                    >
                                        {weeklyAiResponse}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                סגור
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Component for Image Viewer Modal
        const ImageViewerModal = ({ show, onClose, imageUrl, darkMode }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className={`relative rounded-lg p-4 shadow-xl w-full max-w-sm sm:max-w-md md:max-w-lg lg:max-w-3xl max-h-[90vh] overflow-auto no-scrollbar
                        ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                        <button
                            onClick={onClose}
                            className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl font-bold"
                        >
                            &times;
                        </button>
                        <img src={imageUrl} alt="תמונה מצורפת" className="max-w-full max-h-[85vh] mx-auto"
                             onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/400x300/e0e0e0/555555?text=שגיאת+טעינת+תמונה"; }} />
                    </div>
                </div>
            );
        };

        // Component for Experiment Details Modal
        const ExperimentDetailsModal = ({ show, onClose, onSave, initialExperiment, darkMode, callGeminiAPI, geminiApiKey, aiResponseStyles,
            setShowExperimentGuidingQuestionsModal, setExperimentGuidingQuestions, setOriginalExperimentDescriptionForRefinement,
            isGeneratingExperimentQuestions, isRefiningExperimentDescription, setIsGeneratingExperimentQuestions, setIsRefiningExperimentDescription }) => {
            const [experiment, setExperiment] = React.useState(initialExperiment || {
                id: `exp-${Date.now()}`,
                name: '',
                description: '',
                collaborators: [],
                attachments: [],
                weeks: {}
            });
            const [newCollaborator, setNewCollaborator] = React.useState('');
            const [newAttachmentUrl, setNewAttachmentUrl] = React.useState('');
            const [newAttachmentName, setNewAttachmentName] = React.useState('');

            React.useEffect(() => {
                if (initialExperiment) {
                    setExperiment(initialExperiment);
                } else {
                    setExperiment({
                        id: `exp-${Date.now()}`,
                        name: '',
                        description: '',
                        collaborators: [],
                        attachments: [],
                        weeks: {}
                    });
                }
                setNewCollaborator('');
                setNewAttachmentUrl('');
                setNewAttachmentName('');
            }, [initialExperiment, show]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setExperiment(prev => ({ ...prev, [name]: value }));
            };

            const handleAddCollaborator = () => {
                if (newCollaborator.trim()) {
                    setExperiment(prev => ({
                        ...prev,
                        collaborators: [...prev.collaborators, newCollaborator.trim()]
                    }));
                    setNewCollaborator('');
                }
            };

            const handleRemoveCollaborator = (indexToRemove) => {
                setExperiment(prev => ({
                    ...prev,
                    collaborators: prev.collaborators.filter((_, index) => index !== indexToRemove)
                }));
            };

            const handleAddAttachment = () => {
                if (newAttachmentUrl.trim() && newAttachmentName.trim()) {
                    setExperiment(prev => ({
                        ...prev,
                        attachments: [...prev.attachments, { url: newAttachmentUrl.trim(), name: newAttachmentName.trim() }]
                    }));
                    setNewAttachmentUrl('');
                    setNewAttachmentName('');
                } else {
                    alert('אנא הזן גם קישור וגם שם לקובץ המצורף.');
                }
            };

            const handleRemoveAttachment = (indexToRemove) => {
                setExperiment(prev => ({
                    ...prev,
                    attachments: prev.attachments.filter((_, index) => index !== indexToRemove)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (experiment.name.trim()) {
                    onSave(experiment);
                } else {
                    alert('שם הניסוי הוא שדה חובה.');
                }
            };

            // New handler for generating experiment description questions
            const handleGenerateExperimentDescriptionQuestions = async () => {
                const currentExpDescription = experiment.description || '';
                if (!currentExpDescription.trim()) {
                    alert('אנא הזן תיאור קיים כדי לשפר אותו.');
                    return;
                }
                if (!geminiApiKey) { // Check if API key is passed and available
                    alert('אנא הזן את מפתח ה-API של Gemini כדי להשתמש בפונקציות ה-AI.');
                    return;
                }

                const numQuestions = aiResponseStyles.experimentDescription.numGuidingQuestions || 3;

                if (numQuestions > 0) {
                    setIsGeneratingExperimentQuestions(true);

                    const formulationInstructions = [];
                    const currentAiStyle = aiResponseStyles.experimentDescription;
                    if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                        formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                    }
                    if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                        formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                    }
                    const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                    const questionSchema = {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    };
                    const promptForQuestions = `${formulationPrefix}בהתבסס על תיאור הניסוי הבא, צור ${numQuestions} שאלות מנחות תמציתיות (עד 20 מילים לשאלה) שיעזרו לדייק ולשפר אותו. השב בפורמט JSON של מערך מחרוזות. השב בעברית.
                    \n\nתיאור הניסוי: "${currentExpDescription}"`;

                    const generatedQuestions = await callGeminiAPI(promptForQuestions, questionSchema);

                    if (generatedQuestions && generatedQuestions.length > 0) {
                        setExperimentGuidingQuestions(generatedQuestions);
                        setOriginalExperimentDescriptionForRefinement(currentExpDescription);
                        setShowExperimentGuidingQuestionsModal(true);
                    } else {
                        alert('ה-AI לא הצליח ליצור שאלות מנחות עבור תיאור הניסוי. אנא נסה שוב.');
                    }
                    setIsGeneratingExperimentQuestions(false);
                }
            };


            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg sm:max-w-md
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">
                            {initialExperiment ? 'ערוך פרטי ניסוי' : 'הוסף ניסוי חדש'}
                        </h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label htmlFor="expName" className="block text-sm font-medium mb-1">
                                    שם ניסוי:
                                </label>
                                <input
                                    type="text"
                                    id="expName"
                                    name="name"
                                    value={experiment.name}
                                    onChange={handleChange}
                                    className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                        ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="expDescription" className="block text-sm font-medium mb-1">
                                    תיאור ניסוי:
                                </label>
                                <textarea
                                    id="expDescription"
                                    name="description"
                                    rows="3"
                                    value={experiment.description}
                                    onChange={handleChange}
                                    className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                        ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                ></textarea>
                                <button
                                    type="button"
                                    onClick={handleGenerateExperimentDescriptionQuestions}
                                    disabled={isGeneratingExperimentQuestions || isRefiningExperimentDescription || !geminiApiKey}
                                    className={`px-3 py-1 rounded-lg shadow-sm text-xs sm:text-sm mt-2 flex items-center justify-center gap-1
                                        ${(isGeneratingExperimentQuestions || isRefiningExperimentDescription || !geminiApiKey) ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600 text-white'}
                                        transition-colors duration-200`}
                                >
                                    {isGeneratingExperimentQuestions ? 'יוצר שאלות...' : isRefiningExperimentDescription ? 'מחדד תיאור...' : '✨ שפר תיאור ניסוי'}
                                </button>
                            </div>

                            {/* Collaborators Section */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-2">שותפים:</label>
                                <div className="flex flex-wrap gap-2 mb-2">
                                    {experiment.collaborators.map((collab, index) => (
                                        <span key={index} className={`flex items-center px-2 py-1 rounded-full text-xs
                                            ${darkMode ? 'bg-blue-700 text-blue-100' : 'bg-blue-200 text-blue-800'}`}>
                                            {collab}
                                            <button
                                                type="button"
                                                onClick={() => handleRemoveCollaborator(index)}
                                                className="ml-1 text-red-500 hover:text-red-700 text-base"
                                            >
                                                &times;
                                            </button>
                                        </span>
                                    ))}
                                </div>
                                <div className="flex gap-2 flex-wrap sm:flex-nowrap">
                                    <input
                                        type="text"
                                        placeholder="הוסף שם שותף"
                                        value={newCollaborator}
                                        onChange={(e) => setNewCollaborator(e.target.value)}
                                        onKeyPress={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddCollaborator(); } }}
                                        className={`flex-grow p-2 border rounded-md text-sm w-full sm:w-auto
                                            ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                    />
                                    <button
                                        type="button"
                                        onClick={handleAddCollaborator}
                                        className={`px-3 py-1 rounded-lg shadow-sm text-sm w-full sm:w-auto
                                            ${darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                                    >
                                        הוסף
                                    </button>
                                </div>
                            </div>

                            {/* Attachments Section */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-2">קבצים מצורפים (קישורים):</label>
                                <div className="flex flex-col gap-2 mb-2">
                                    {experiment.attachments.map((att, index) => (
                                        <div key={index} className={`flex items-center justify-between p-2 rounded-md
                                            ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                            <span className="text-sm truncate">{att.name} ({att.url})</span>
                                            <button
                                                type="button"
                                                onClick={() => handleRemoveAttachment(index)}
                                                className="text-red-500 hover:text-red-700 text-lg"
                                                title="מחק קובץ מצורף"
                                            >
                                                &times;
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                    <input
                                        type="text"
                                        placeholder="שם קובץ"
                                        value={newAttachmentName}
                                        onChange={(e) => setNewAttachmentName(e.target.value)}
                                        className={`flex-grow p-2 border rounded-md text-sm w-full sm:w-auto
                                            ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                    />
                                    <input
                                        type="url"
                                        placeholder="קישור לקובץ/תמונה (URL)"
                                        value={newAttachmentUrl}
                                        onChange={(e) => setNewAttachmentUrl(e.target.value)}
                                        className={`flex-grow p-2 border rounded-md text-sm w-full sm:w-auto
                                            ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                    />
                                    <button
                                        type="button"
                                        onClick={handleAddAttachment}
                                        className={`px-3 py-1 rounded-lg shadow-sm text-sm w-full sm:w-auto
                                            ${darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                                    >
                                        הוסף
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 dark:text-gray-400">
                                    *הערה: אין אפשרות להעלות קבצים ישירות ללא שרת. ניתן לצרף קישורים לקבצים קיימים ברשת (כמו תמונות, מסמכים ב-Google Drive וכו').
                                </p>
                            </div>

                            <div className="flex justify-end gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className={`px-4 py-2 rounded-lg shadow-md
                                        ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}
                                        ${(isGeneratingExperimentQuestions || isRefiningExperimentDescription) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    disabled={isGeneratingExperimentQuestions || isRefiningExperimentDescription}
                                >
                                    ביטול
                                </button>
                                <button
                                    type="submit"
                                    className={`px-4 py-2 rounded-lg shadow-md
                                        ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}
                                        ${(isGeneratingExperimentQuestions || isRefiningExperimentDescription) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    disabled={isGeneratingExperimentQuestions || isRefiningExperimentDescription}
                                >
                                    שמור ניסוי
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Component for Table AI Response Modal
        const TableAiResponseModal = ({ show, onClose, title, content, darkMode, aiResponseStyle = {} }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg sm:max-w-md
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">{title}</h2>
                        <div
                            className="whitespace-pre-wrap mb-4 max-h-[50vh] overflow-y-auto no-scrollbar" // Limited height and scrollable
                            style={{ fontSize: aiResponseStyle.fontSize, color: aiResponseStyle.textColor }}
                        >
                            {content}
                        </div>
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                סגור
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // AiActionConfirmationModal Component
        const AiActionConfirmationModal = ({ show, onClose, onConfirm, aiResponse, darkMode }) => {
            if (!show || !aiResponse) return null;

            const { action, target, textResponse } = aiResponse;

            const renderActionDetails = () => {
                if (!target) return <p>אין פרטים ספציפיים לפעולה.</p>;

                switch (action) {
                    case 'add_task':
                        return (
                            <div>
                                <p className="font-semibold">הוספת משימה חדשה:</p>
                                <ul className="list-disc list-inside text-sm">
                                    <li><strong>ניסוי:</strong> {target.experimentName}</li>
                                    <li><strong>שבוע:</strong> {target.weekId}</li>
                                    <li><strong>כותרת:</strong> {target.taskTitle || 'לא צוין'}</li>
                                    <li><strong>תיאור:</strong> {target.taskDescription || 'לא צוין'}</li>
                                    <li><strong>סטטוס:</strong> {target.taskStatus || 'רגיל'}</li>
                                    <li><strong>תגיות:</strong> {target.taskTags ? target.taskTags.join(', ') : 'אין'}</li>
                                    {target.isCompleted !== undefined && <li><strong>בוצע:</strong> {target.isCompleted ? 'כן' : 'לא'}</li>}
                                    {target.isRecurring && (
                                        <>
                                            <li><strong>חוזרת:</strong> כן</li>
                                            <li><strong>תדירות:</strong> {target.recurrenceType === 'bi-weekly' ? 'דו-שבועית' : 'שבועית'}</li>
                                            <li><strong>עד תאריך:</strong> {target.recurrenceEndDate || 'אין'}</li>
                                        </>
                                    )}
                                </ul>
                            </div>
                        );
                    case 'edit_task':
                        return (
                            <div>
                                <p className="font-semibold">עריכת משימה קיימת:</p>
                                <ul className="list-disc list-inside text-sm">
                                    <li><strong>ניסוי:</strong> {target.experimentName}</li>
                                    <li><strong>שבוע:</strong> {target.weekId}</li>
                                    <li><strong>מזהה משימה/כותרת:</strong> {target.taskId || target.taskTitle || 'לא צוין'}</li>
                                    {target.taskTitle && <li><strong>כותרת חדשה:</strong> {target.taskTitle}</li>}
                                    {target.taskDescription && <li><strong>תיאור חדש:</strong> {target.taskDescription}</li>}
                                    {target.taskStatus && <li><strong>סטטוס חדש:</strong> {target.taskStatus}</li>}
                                    {target.taskTags && <li><strong>תגיות חדשות:</strong> {target.taskTags.join(', ')}</li>}
                                    {target.isCompleted !== undefined && <li><strong>סטטוס ביצוע:</strong> {target.isCompleted ? 'בוצע' : 'לא בוצע'}</li>}
                                </ul>
                            </div>
                        );
                    case 'delete_task':
                        return (
                            <div>
                                <p className="font-semibold">מחיקת משימה:</p>
                                <ul className="list-disc list-inside text-sm">
                                    <li><strong>ניסוי:</strong> {target.experimentName}</li>
                                    <li><strong>שבוע:</strong> {target.weekId}</li>
                                    <li><strong>מזהה משימה/כותרת:</strong> {target.taskId || target.taskTitle || 'לא צוין'}</li>
                                </ul>
                            </div>
                        );
                    case 'add_experiment':
                        return (
                            <div>
                                <p className="font-semibold">הוספת ניסוי חדש:</p>
                                <ul className="list-disc list-inside text-sm">
                                    <li><strong>שם ניסוי:</strong> {target.experimentName}</li>
                                    <li><strong>תיאור:</strong> {target.experimentDescription || 'אין תיאור'}</li>
                                    <li><strong>שותפים:</strong> {target.collaborators ? target.collaborators.join(', ') : 'אין'}</li>
                                    <li><strong>קבצים מצורפים:</strong> {target.attachments && target.attachments.length > 0 ? target.attachments.map(a => a.name).join(', ') : 'אין'}</li>
                                </ul>
                            </div>
                        );
                    case 'none':
                    default:
                        return <p>ה-AI לא זיהה פעולה ספציפית לביצוע על הנתונים.</p>;
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg sm:max-w-md
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">אישור פעולת AI</h2>
                        <div className="mb-4">
                            <p className="font-medium mb-2">ה-AI מציע לבצע את הפעולה הבאה:</p>
                            {renderActionDetails()}
                            <p className="mt-4 text-sm italic">{textResponse}</p>
                        </div>
                        <div className="flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                ביטול
                            </button>
                            {action !== 'none' && (
                                <button
                                    onClick={onConfirm}
                                    className={`px-4 py-2 rounded-lg shadow-md bg-green-500 hover:bg-green-600 text-white`}
                                >
                                    אשר ויישם
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // New Component: GuidingQuestionsModal
        const GuidingQuestionsModal = ({ show, onClose, questions, onComplete, originalDescription, darkMode, aiResponseStyle = {} }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);
            const [currentAnswer, setCurrentAnswer] = React.useState('');
            const [answers, setAnswers] = React.useState({}); // Store answers by question index

            React.useEffect(() => {
                // When modal opens or questions change, reset answers and index
                if (show) {
                    setAnswers({});
                    setCurrentQuestionIndex(0);
                    setCurrentAnswer('');
                }
            }, [show, questions]);

            React.useEffect(() => {
                // Update currentAnswer when currentQuestionIndex changes
                setCurrentAnswer(answers[currentQuestionIndex] || '');
            }, [currentQuestionIndex, answers]);

            if (!show || questions.length === 0) return null;

            const handleNext = () => {
                setAnswers(prev => ({ ...prev, [currentQuestionIndex]: currentAnswer }));
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(prev => prev + 1);
                } else {
                    // All questions answered, complete the process
                    onComplete({ ...answers, [currentQuestionIndex]: currentAnswer }, originalDescription); // Pass originalDescription here
                }
            };

            const handlePrevious = () => {
                setAnswers(prev => ({ ...prev, [currentQuestionIndex]: currentAnswer }));
                if (currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(prev => prev - 1);
                }
            };

            const currentQuestion = questions[currentQuestionIndex];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-lg
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">שאלות מנחות לשיפור תיאור</h2>
                        <p className="mb-4 text-sm">
                            שאלה {currentQuestionIndex + 1} מתוך {questions.length}:
                        </p>
                        <div className="mb-4 p-3 rounded-md border ${darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-100 bg-white'}">
                            <p className="font-semibold mb-2" style={{ fontSize: aiResponseStyle.fontSize, color: aiResponseStyle.textColor }}>
                                {currentQuestion}
                            </p>
                            <textarea
                                rows="3"
                                value={currentAnswer}
                                onChange={(e) => setCurrentAnswer(e.target.value)}
                                placeholder="הזן את תשובתך כאן..."
                                className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            ></textarea>
                        </div>
                        <div className="flex justify-between gap-3">
                            <button
                                onClick={handlePrevious}
                                disabled={currentQuestionIndex === 0}
                                className={`px-4 py-2 rounded-lg shadow-md text-sm
                                    ${currentQuestionIndex === 0 ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : (darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800')}`}
                            >
                                קודם
                            </button>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className={`px-4 py-2 rounded-lg shadow-md text-sm
                                        ${darkMode ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-red-500 hover:bg-red-600 text-white'}`}
                                >
                                    ביטול
                                </button>
                                <button
                                    onClick={handleNext}
                                    className={`px-4 py-2 rounded-lg shadow-md text-sm
                                        ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                                >
                                    {currentQuestionIndex === questions.length - 1 ? 'סיים וצור תיאור' : 'הבא'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // New Component: AiResponseConfigModal
        const AiResponseConfigModal = ({ show, onClose, aiResponseStyles, onSaveStyles, darkMode }) => {
            const [selectedComponent, setSelectedComponent] = React.useState('summary');
            const [fontSize, setFontSize] = React.useState(aiResponseStyles[selectedComponent]?.fontSize || '14px');
            const [textColor, setTextColor] = React.useState(aiResponseStyles[selectedComponent]?.textColor || (darkMode ? '#e2e8f0' : '#1a202c')); // Default to gray-200 or gray-900
            const [formulationStyle, setFormulationStyle] = React.useState(aiResponseStyles[selectedComponent]?.formulationStyle || 'default');
            const [generalInstructions, setGeneralInstructions] = React.useState(aiResponseStyles[selectedComponent]?.generalInstructions || '');
            const [numGuidingQuestions, setNumGuidingQuestions] = React.useState(aiResponseStyles[selectedComponent]?.numGuidingQuestions || 3);


            React.useEffect(() => {
                // Update local state when selectedComponent or aiResponseStyles change
                setFontSize(aiResponseStyles[selectedComponent]?.fontSize || '14px');
                setTextColor(aiResponseStyles[selectedComponent]?.textColor || (darkMode ? '#e2e8f0' : '#1a202c'));
                setFormulationStyle(aiResponseStyles[selectedComponent]?.formulationStyle || 'default');
                setGeneralInstructions(aiResponseStyles[selectedComponent]?.generalInstructions || '');
                setNumGuidingQuestions(aiResponseStyles[selectedComponent]?.numGuidingQuestions || 3);
            }, [selectedComponent, aiResponseStyles, darkMode]);

            if (!show) return null;

            const components = [
                { value: 'summary', label: 'סיכום ניסוי' },
                { value: 'monthly', label: 'סיכום חודשי' },
                { value: 'weekly', label: 'משימות שבועיות' },
                { value: 'table', label: 'תגובת AI לטבלה' },
                { value: 'experimentDescription', label: 'תיאור ניסוי' }, // New component for experiment description
            ];

            const fontSizes = ['12px', '14px', '16px', '18px', '20px'];
            const formulationStyles = [
                { value: 'default', label: 'ברירת מחדל' },
                { value: 'concise', label: 'תמציתי' },
                { value: 'detailed', label: 'מפורט' },
                { value: 'professional', label: 'מקצועי' },
                { value: 'friendly', label: 'ידידותי' },
                { value: 'critical', label: 'ביקורתי' },
                { value: 'encouraging', label: 'מעודד' },
            ];


            const handleSave = () => {
                const updatedStyles = { fontSize, textColor, formulationStyle, generalInstructions };
                if (selectedComponent === 'weekly' || selectedComponent === 'experimentDescription') {
                    updatedStyles.numGuidingQuestions = numGuidingQuestions;
                }
                onSaveStyles(selectedComponent, updatedStyles);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`rounded-lg p-6 shadow-xl w-full max-w-md
                        ${darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                        <h2 className="text-xl font-semibold mb-4">הגדרות תצוגת AI</h2>

                        <div className="mb-4">
                            <label htmlFor="aiComponentSelect" className="block text-sm font-medium mb-1">
                                בחר רכיב AI:
                            </label>
                            <select
                                id="aiComponentSelect"
                                value={selectedComponent}
                                onChange={(e) => setSelectedComponent(e.target.value)}
                                className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            >
                                {components.map(comp => (
                                    <option key={comp.value} value={comp.value}>{comp.label}</option>
                                ))}
                            </select>
                        </div>

                        <div className="mb-4">
                            <label htmlFor="fontSizeSelect" className="block text-sm font-medium mb-1">
                                גודל גופן:
                            </label>
                            <select
                                id="fontSizeSelect"
                                value={fontSize}
                                onChange={(e) => setFontSize(e.target.value)}
                                className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            >
                                {fontSizes.map(size => (
                                    <option key={size} value={size}>{size}</option>
                                ))}
                            </select>
                        </div>

                        <div className="mb-4">
                            <label htmlFor="textColorPicker" className="block text-sm font-medium mb-1">
                                צבע טקסט:
                            </label>
                            <input
                                type="color"
                                id="textColorPicker"
                                value={textColor}
                                onChange={(e) => setTextColor(e.target.value)}
                                className="w-full h-8 sm:h-10 rounded-md border-gray-300 dark:border-gray-600"
                            />
                        </div>

                        <div className="mb-4">
                            <label htmlFor="formulationStyleSelect" className="block text-sm font-medium mb-1">
                                סגנון ניסוח:
                            </label>
                            <select
                                id="formulationStyleSelect"
                                value={formulationStyle}
                                onChange={(e) => setFormulationStyle(e.target.value)}
                                className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            >
                                {formulationStyles.map(style => (
                                    <option key={style.value} value={style.value}>{style.label}</option>
                                ))}
                            </select>
                        </div>

                        <div className="mb-4">
                            <label htmlFor="generalInstructionsTextarea" className="block text-sm font-medium mb-1">
                                הוראות ניסוח כלליות (לדוגמה: "פעל כיועץ מדעי"):
                            </label>
                            <textarea
                                id="generalInstructionsTextarea"
                                rows="3"
                                value={generalInstructions}
                                onChange={(e) => setGeneralInstructions(e.target.value)}
                                placeholder="הזן הוראות נוספות ל-AI לגבי אופן הניסוח..."
                                className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            ></textarea>
                        </div>

                        {(selectedComponent === 'weekly' || selectedComponent === 'experimentDescription') && (
                            <div className="mb-4">
                                <label htmlFor="numGuidingQuestionsInput" className="block text-sm font-medium mb-1">
                                    מספר שאלות מנחות (לשיפור תיאור):
                                </label>
                                <input
                                    type="number"
                                    id="numGuidingQuestionsInput"
                                    min="1"
                                    max="10"
                                    value={numGuidingQuestions}
                                    onChange={(e) => setNumGuidingQuestions(parseInt(e.target.value) || 1)}
                                    className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                        ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                />
                            </div>
                        )}

                        <div className="flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                ביטול
                            </button>
                            <button
                                onClick={handleSave}
                                className={`px-4 py-2 rounded-lg shadow-md
                                    ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                            >
                                שמור הגדרות
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // Main App component
        const App = () => {
            // State for all application data
            const [appData, setAppData] = React.useState(() => {
                const storedData = localStorage.getItem('experimentBoardData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Ensure archivedExperiments exists in loaded data
                    if (!parsedData.archivedExperiments) {
                        parsedData.archivedExperiments = [];
                    }
                    // Ensure new fields exist for existing experiments
                    const updatedExperiments = (parsedData.experiments || []).map(exp => ({
                        ...exp,
                        description: exp.description || '',
                        collaborators: exp.collaborators || [],
                        attachments: exp.attachments || []
                    }));
                    const updatedArchivedExperiments = (parsedData.archivedExperiments || []).map(exp => ({
                        ...exp,
                        description: exp.description || '',
                        collaborators: exp.collaborators || [],
                        attachments: exp.attachments || []
                    }));

                    // Ensure aiResponseStyles exists and set default numGuidingQuestions
                    const defaultAiResponseStyles = {
                        summary: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        monthly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        weekly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                        table: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        experimentDescription: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 }, // New style
                    };
                    const loadedAiResponseStyles = {
                        ...defaultAiResponseStyles,
                        ...(parsedData.aiResponseStyles || {}),
                        weekly: {
                            ...defaultAiResponseStyles.weekly,
                            ...(parsedData.aiResponseStyles?.weekly || {})
                        },
                        experimentDescription: {
                            ...defaultAiResponseStyles.experimentDescription,
                            ...(parsedData.aiResponseStyles?.experimentDescription || {})
                        }
                    };


                    return {
                        ...parsedData,
                        experiments: updatedExperiments,
                        archivedExperiments: updatedArchivedExperiments,
                        aiResponseStyles: loadedAiResponseStyles
                    };
                }
                // Initial dummy data if no stored data
                return {
                    experiments: [
                        {
                            id: 'exp-1',
                            name: 'ניסוי לדוגמה 1',
                            description: 'זהו ניסוי ראשוני לבדיקת מערכת ניהול הניסויים. מטרתו לוודא את תקינות הממשק והפונקציונליות הבסיסית.',
                            collaborators: ['איתי כהן', 'נועה לוי'],
                            attachments: [{ name: 'פרוטוקול ניסוי', url: 'https://example.com/protocol.pdf' }],
                            weeks: {
                                // Use a recent week ID for better visibility on initial load
                                // This will be dynamic based on tableStartDate
                                '2024-11-03': [ // Example, will be replaced by dynamic date
                                    { id: 'task-1-1', title: 'משימה חשובה', description: 'יש לתכנן את שלבי הניסוי בקפידה ולאסוף את כל הריאגנטים הנדרשים. ודא שכל הציוד מכויל.', completed: false, status: 'important', tags: ['תכנון', 'ריאגנטים'] },
                                    { id: 'task-1-2', title: 'הכנת דגימות', description: 'הכנת 10 דגימות לפי פרוטוקול A. יש לוודא סטריליות מלאה.', completed: true, status: 'completed', tags: ['מעבדה', 'דגימות'] },
                                ],
                                '2024-11-10': [
                                    { id: 'task-1-3', title: 'ניתוח ראשוני', description: 'ביצוע ניתוח ראשוני של הנתונים שנאספו משלב הדגימות. יש להשתמש בתוכנה X.', completed: false, status: 'pending', tags: ['ניתוח', 'נתונים'] },
                                ]
                            }
                        },
                    ], // Only one default experiment
                    archivedExperiments: [],
                    hiddenColumns: [],
                    columnStyles: {},
                    expectedWeekCount: 52, // Default to 52 weeks
                    rowStyles: {},
                    darkMode: false,
                    aiResponseStyles: { // New state for AI response styles
                        summary: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        monthly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        weekly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                        table: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        experimentDescription: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 }, // New style
                    }
                };
            });

            // State for special edit mode
            const [isSpecialEditMode, setIsSpecialEditMode] = React.useState(false);

            // State for the list of all weeks to display, structured hierarchically
            const [structuredWeeks, setStructuredWeeks] = React.useState([]);

            // State for the current week ID to highlight
            const [currentWeekId, setCurrentWeekId] = React.useState('');

            // State for the table's start date, controlled by the date picker
            const [tableStartDate, setTableStartDate] = React.useState(() => {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
                const currentSunday = new Date(today);
                currentSunday.setDate(today.getDate() - dayOfWeek); // Go back to Sunday
                return currentSunday.toISOString().split('T')[0];
            });

            // State for filtering experiments (active, archived, all)
            const [experimentFilter, setExperimentFilter] = React.useState('active'); // 'active', 'archived', 'all'

            // State for searching experiments
            const [searchTerm, setSearchTerm] = React.useState('');

            // Refs for modals and textarea
            const tableContainerRef = React.useRef(null); // Ref for scrolling to current week
            const tableHeaderRef = React.useRef(null); // Ref for the table header
            const taskModalRef = React.useRef(null);
            const styleModalRef = React.useRef(null);
            const descriptionTextareaRef = React.useRef(null); // Ref for task description textarea

            // State for task modal
            const [showTaskModal, setShowTaskModal] = React.useState(false);
            const [currentTask, setCurrentTask] = React.useState(null); // Task being edited/added
            const [currentExperimentId, setCurrentExperimentId] = React.useState(null); // Experiment ID for the task
            const [currentWeekIdForTask, setCurrentWeekIdForTask] = React.useState(null); // Week ID for the task
            const [selectedTaskStatus, setSelectedTaskStatus] = React.useState('default'); // Status for new/edited tasks
            const [currentTaskTitle, setCurrentTaskTitle] = React.useState(''); // Title for new/edited tasks
            const [currentTaskDescription, setCurrentTaskDescription] = React.useState(''); // Description for new/edited tasks
            const [currentTaskTags, setCurrentTaskTags] = React.useState(''); // Tags for new/edited tasks (comma separated string)
            const [currentAttachments, setCurrentAttachments] = React.useState([]); // Attachments for current task
            const [newAttachmentUrl, setNewAttachmentUrl] = React.useState(''); // Input for new attachment URL
            const [newAttachmentName, setNewAttachmentName] = React.useState(''); // Input for new attachment name
            // Google Calendar specific states
            const [googleCalendarStartDate, setGoogleCalendarStartDate] = React.useState('');
            const [googleCalendarStartTime, setGoogleCalendarStartTime] = React.useState('');
            const [googleCalendarEndDate, setGoogleCalendarEndDate] = React.useState('');
            const [googleCalendarEndTime, setGoogleCalendarEndTime] = React.useState('');
            // Recurrence states for task modal
            const [isRecurring, setIsRecurring] = React.useState(false);
            const [recurrenceType, setRecurrenceType] = React.useState('weekly'); // 'weekly', 'bi-weekly'
            const [recurrenceEndDate, setRecurrenceEndDate] = React.useState('');


            // State for style modal
            const [showStyleModal, setShowStyleModal] = React.useState(false);
            const [currentStyleTarget, setCurrentStyleTarget] = React.useState({ type: '', id: '' }); // 'column' or 'row'
            const [selectedColor, setSelectedColor] = React.useState('#ffffff'); // Default color for picker
            const [selectedTextColor, setSelectedTextColor] = React.useState('#000000'); // Default text color for picker

            // States for LLM features
            const [isGeneratingDescription, setIsGeneratingDescription] = React.useState(false);
            const [isGeneratingSummary, setIsGeneratingSummary] = React.useState(false);
            const [showSummaryModal, setShowSummaryModal] = React.useState(false);
            const [experimentSummary, setExperimentSummary] = React.useState('');

            const [showMonthlySummaryModal, setShowMonthlySummaryModal] = React.useState(false);
            const [monthlySummaryContent, setMonthlySummaryContent] = React.useState('');
            const [isGeneratingMonthlySummary, setIsGeneratingMonthlySummary] = React.useState(false);

            const [showWeeklyTasksModal, setShowWeeklyTasksModal] = React.useState(false);
            const [weeklyTasksList, setWeeklyTasksList] = React.useState([]); // Now an object of grouped tasks

            const [showImageViewerModal, setShowImageViewerModal] = React.useState(false);
            const [imageToView, setImageToView] = React.useState('');

            // State to track if initial scroll has been performed
            const [initialScrollDone, setInitialScroll] = React.useState(false);

            // State for Table AI interaction
            const [showTableAiModal, setShowTableAiModal] = React.useState(false);
            const [tableAiPrompt, setTableAiPrompt] = React.useState('');
            const [tableAiResponse, setTableAiResponse] = React.useState('');
            const [isGeneratingTableAi, setIsGeneratingTableAi] = React.useState(false);

            // States for AI Action Confirmation
            const [showAiActionConfirmModal, setShowAiActionConfirmModal] = React.useState(false);
            const [aiProposedAction, setAiProposedAction] = React.useState(null);

            // State for AI Response Config Modal
            const [showAiConfigModal, setShowAiConfigModal] = React.useState(false);

            // New states for Guiding Questions feature (for tasks)
            const [showGuidingQuestionsModal, setShowGuidingQuestionsModal] = React.useState(false);
            const [guidingQuestions, setGuidingQuestions] = React.useState([]);
            const [originalDescriptionForRefinement, setOriginalDescriptionForRefinement] = React.useState(''); // New state to hold original task description
            const [isGeneratingQuestions, setIsGeneratingQuestions] = React.useState(false); // For task questions
            const [isRefiningDescription, setIsRefiningDescription] = React.useState(false); // For task description refinement

            // New states for Guiding Questions feature (for experiment description)
            const [showExperimentGuidingQuestionsModal, setShowExperimentGuidingQuestionsModal] = React.useState(false);
            const [experimentGuidingQuestions, setExperimentGuidingQuestions] = React.useState([]);
            const [originalExperimentDescriptionForRefinement, setOriginalExperimentDescriptionForRefinement] = React.useState(''); // New state for original experiment description
            const [isGeneratingExperimentQuestions, setIsGeneratingExperimentQuestions] = React.useState(false);
            const [isRefiningExperimentDescription, setIsRefiningExperimentDescription] = React.useState(false);


            // State for confirmation modal
            const [showConfirmModal, setShowConfirmModal] = React.useState(false);
            const [confirmAction, setConfirmAction] = React.useState(null);
            const [confirmTitle, setConfirmTitle] = React.useState('');
            const [confirmMessage, setConfirmMessage] = React.useState('');

            // State for Gemini API Key
            const [geminiApiKey, setGeminiApiKey] = React.useState(appData.geminiApiKey || '');

            // New state for Experiment Details Modal
            const [showExperimentDetailsModal, setShowExperimentDetailsModal] = React.useState(false);
            const [currentExperimentDetails, setCurrentExperimentDetails] = React.useState(null);

            // State for task description tooltip
            const [tooltipTimeout, setTooltipTimeout] = React.useState(null);
            const [showTooltip, setShowTooltip] = React.useState(false);
            const [tooltipContent, setTooltipContent] = React.useState('');
            const [tooltipPosition, setTooltipPosition] = React.useState({ x: 0, y: 0 });

            // New state for tracking hovered experiment for description visibility
            const [hoveredExperimentId, setHoveredExperimentId] = React.useState(null);


            // Define task status options and their corresponding Tailwind CSS classes
            const taskStatusOptions = [
                { value: 'default', label: 'רגיל', bgColorClass: 'bg-gray-100 dark:bg-gray-600', textColorClass: 'text-gray-800 dark:text-gray-100' },
                { value: 'important', label: 'חשוב', bgColorClass: 'bg-yellow-200 dark:bg-yellow-700', textColorClass: 'text-yellow-800 dark:text-yellow-100' },
                { value: 'completed', label: 'בוצע', bgColorClass: 'bg-green-200 dark:bg-green-700', textColorClass: 'text-green-800 dark:text-green-100' },
                { value: 'warning', label: 'אזהרה', bgColorClass: 'bg-red-200 dark:bg-red-700', textColorClass: 'text-red-800 dark:text-red-100' },
                { value: 'info', label: 'מידע', bgColorClass: 'bg-blue-200 dark:bg-blue-700', textColorClass: 'text-blue-800 dark:text-blue-100' },
            ];

            // Function to call Gemini API for text generation
            const callGeminiAPI = async (prompt, responseSchema = null) => {
                if (!geminiApiKey) {
                    // Using a custom alert for better UX
                    alert('אנא הזן את מפתח ה-API של Gemini כדי להשתמש בפונקציות ה-AI.');
                    return responseSchema ? { action: "none", textResponse: "שגיאה: מפתח API חסר." } : "שגיאה: מפתח API חסר.";
                }
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };

                    if (responseSchema) {
                        payload.generationConfig = {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        };
                    }

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        if (responseSchema) {
                            try {
                                return JSON.parse(text); // Return parsed JSON if schema was requested
                            } catch (e) {
                                console.error("Failed to parse JSON response from Gemini:", text, e);
                                return responseSchema.type === "ARRAY" ? [] : { action: "none", textResponse: "ה-AI לא הצליח ליצור תגובה בפורמט הנדרש. אנא נסה שוב או נסח מחדש את בקשתך." };
                            }
                        }
                        return text; // Return raw text otherwise
                    } else {
                        console.error("Gemini API returned an unexpected structure or no content:", result);
                        return responseSchema ? (responseSchema.type === "ARRAY" ? [] : { action: "none", textResponse: "אירעה שגיאה ביצירת התוכן. אנא נסה שוב." }) : "אירעה שגיאה ביצירת התוכן. אנא נסה שוב.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return responseSchema ? (responseSchema.type === "ARRAY" ? [] : { action: "none", textResponse: "אירעה שגיאה בתקשורת עם ה-API. אנא ודא חיבור אינטרנט ונסה שוב." }) : "אירעה שגיאה בתקשורת עם ה-API. אנא ודא חיבור אינטרנט ונסה שוב.";
                }
            };

            // Function to generate all weeks from a given start date for a fixed number of weeks
            const getWeeksInRangeBySundayDate = React.useCallback((startDateStr) => {
                const years = {};
                let currentDate = new Date(startDateStr);

                // Find the first Sunday on or after currentDate
                while (currentDate.getDay() !== 0) { // 0 is Sunday
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const numWeeksToGenerate = appData.expectedWeekCount || 52; // Use expectedWeekCount from appData, default to 52
                let weeksCount = 0;

                while (weeksCount < numWeeksToGenerate) {
                    const year = currentDate.getFullYear();
                    const monthIndex = currentDate.getMonth();
                    const monthName = new Intl.DateTimeFormat('he-IL', { month: 'long' }).format(currentDate);

                    const day = currentDate.getDate().toString().padStart(2, '0');
                    const weekId = `${year}-${(monthIndex + 1).toString().padStart(2, '0')}-${day}`;
                    const displayDate = `${day}/${(monthIndex + 1).toString().padStart(2, '0')}`;
                    const isoWeekNumber = getISOWeekNumber(currentDate);

                    if (!years[year]) {
                        years[year] = { name: year.toString(), months: {}, totalWeeks: 0 };
                    }
                    if (!years[year].months[monthIndex]) {
                        years[year].months[monthIndex] = { name: monthName, weeks: [], totalWeeks: 0 };
                    }

                    const weekData = {
                        id: weekId,
                        display: displayDate,
                        date: new Date(currentDate),
                        isoWeekNumber: isoWeekNumber,
                        year: year,
                        month: monthIndex,
                        monthName: monthName
                    };

                    years[year].months[monthIndex].weeks.push(weekData);
                    years[year].months[monthIndex].totalWeeks++;
                    years[year].totalWeeks++;

                    currentDate.setDate(currentDate.getDate() + 7); // Move to next Sunday
                    weeksCount++;
                }

                const structured = Object.values(years).map(yearObj => ({
                    ...yearObj,
                    months: Object.values(yearObj.months)
                }));

                return structured;
            }, [appData.expectedWeekCount]); // Dependency on expectedWeekCount

            // Function to get the ID of the current week (Sunday of current week)
            const getCurrentWeekId = React.useCallback(() => {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
                const currentSunday = new Date(today);
                currentSunday.setDate(today.getDate() - dayOfWeek); // Go back to Sunday

                const year = currentSunday.getFullYear();
                const month = (currentSunday.getMonth() + 1).toString().padStart(2, '0');
                const day = currentSunday.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }, []);

            // Load data from localStorage on initial render and initialize weeks
            React.useEffect(() => {
                const storedData = localStorage.getItem('experimentBoardData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Ensure archivedExperiments exists in loaded data
                    if (!parsedData.archivedExperiments) {
                        parsedData.archivedExperiments = [];
                    }
                    // Ensure new fields exist for existing experiments
                    const updatedExperiments = (parsedData.experiments || []).map(exp => ({
                        ...exp,
                        description: exp.description || '',
                        collaborators: exp.collaborators || [],
                        attachments: exp.attachments || []
                    }));
                    const updatedArchivedExperiments = (parsedData.archivedExperiments || []).map(exp => ({
                        ...exp,
                        description: exp.description || '',
                        collaborators: exp.collaborators || [],
                        attachments: exp.attachments || []
                    }));

                    // Ensure aiResponseStyles exists and set default numGuidingQuestions
                    const defaultAiResponseStyles = {
                        summary: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        monthly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        weekly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                        table: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                        experimentDescription: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                    };
                    const loadedAiResponseStyles = {
                        ...defaultAiResponseStyles,
                        ...(parsedData.aiResponseStyles || {}),
                        weekly: {
                            ...defaultAiResponseStyles.weekly,
                            ...(parsedData.aiResponseStyles?.weekly || {})
                        },
                        experimentDescription: {
                            ...defaultAiResponseStyles.experimentDescription,
                            ...(parsedData.aiResponseStyles?.experimentDescription || {})
                        }
                    };

                    setAppData({
                        ...parsedData,
                        experiments: updatedExperiments,
                        archivedExperiments: updatedArchivedExperiments,
                        aiResponseStyles: loadedAiResponseStyles
                    });
                    // Load saved API key
                    if (parsedData.geminiApiKey) {
                        setGeminiApiKey(parsedData.geminiApiKey);
                    }
                }

                // Set default table start date to current date if not already set or if it's in the past
                const today = new Date();
                const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                setTableStartDate(prevDate => {
                    if (!prevDate || new Date(prevDate) > today) { // If no date or date is in future, use today
                        return todayFormatted;
                    }
                    return prevDate;
                });

                setCurrentWeekId(getCurrentWeekId());
            }, [getCurrentWeekId]);

            // Re-generate weeks whenever tableStartDate or expectedWeekCount changes
            React.useEffect(() => {
                const weeks = getWeeksInRangeBySundayDate(tableStartDate);
                setStructuredWeeks(weeks);
            }, [tableStartDate, getWeeksInRangeBySundayDate]);

            // Save data to localStorage whenever appData or geminiApiKey changes
            React.useEffect(() => {
                localStorage.setItem('experimentBoardData', JSON.stringify({ ...appData, geminiApiKey }));
            }, [appData, geminiApiKey]);

            // Effect to add/remove dark mode class
            React.useEffect(() => {
                if (appData.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [appData.darkMode]);

            // Handle clicks outside modals to close them
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (taskModalRef.current && !taskModalRef.current.contains(event.target)) {
                        setShowTaskModal(false);
                    }
                    if (styleModalRef.current && !styleModalRef.current.contains(event.target)) {
                        setShowStyleModal(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            // Initial scroll to current week on load
            React.useEffect(() => {
                if (structuredWeeks.length > 0 && currentWeekId && tableContainerRef.current && !initialScrollDone) {
                    scrollToCurrentWeek();
                    setInitialScroll(true); // Mark as done to prevent re-scrolling on subsequent renders
                }
            }, [structuredWeeks, currentWeekId, initialScrollDone]); // Add initialScrollDone to dependencies

            // Function to add a new experiment row
            const addExperiment = () => {
                setCurrentExperimentDetails(null); // For a new experiment
                setShowExperimentDetailsModal(true);
            };

            // Function to save an experiment (new or edited)
            const saveExperiment = (expToSave) => {
                setAppData(prevData => {
                    const existingIndex = prevData.experiments.findIndex(e => e.id === expToSave.id);
                    if (existingIndex > -1) {
                        // Update existing experiment
                        const updatedExperiments = [...prevData.experiments];
                        updatedExperiments[existingIndex] = expToSave;
                        return { ...prevData, experiments: updatedExperiments };
                    } else {
                        // Add new experiment
                        return { ...prevData, experiments: [...prevData.experiments, expToSave] };
                    }
                });
                setShowExperimentDetailsModal(false);
            };

            // Function to delete an experiment row
            const deleteExperiment = (experimentIdToDelete) => {
                setConfirmTitle('אישור מחיקת ניסוי');
                setConfirmMessage('האם אתה בטוח שברצונך למחוק ניסוי זה? פעולה זו בלתי הפיכה.');
                setConfirmAction(() => () => {
                    setAppData(prevData => ({
                        ...prevData,
                        experiments: prevData.experiments.filter(exp => exp.id !== experimentIdToDelete),
                        archivedExperiments: prevData.archivedExperiments.filter(exp => exp.id !== experimentIdToDelete),
                        rowStyles: Object.fromEntries(
                            Object.entries(prevData.rowStyles).filter(([key]) => key !== experimentIdToDelete)
                        )
                    }));
                    setShowConfirmModal(false);
                });
                setShowConfirmModal(true);
            };

            // Function to archive/restore an experiment
            const toggleArchiveExperiment = (experimentIdToToggle, isCurrentlyArchived) => {
                setAppData(prevData => {
                    let updatedExperiments = [...prevData.experiments];
                    let updatedArchivedExperiments = [...prevData.archivedExperiments];

                    if (isCurrentlyArchived) {
                        // Restore from archive
                        const expToRestore = updatedArchivedExperiments.find(exp => exp.id === experimentIdToToggle);
                        updatedArchivedExperiments = updatedArchivedExperiments.filter(exp => exp.id !== experimentIdToToggle);
                        if (expToRestore) {
                            updatedExperiments.push(expToRestore);
                        }
                    } else {
                        // Archive active experiment
                        const expToArchive = updatedExperiments.find(exp => exp.id === experimentIdToToggle);
                        updatedExperiments = updatedExperiments.filter(exp => exp.id !== experimentIdToToggle);
                        if (expToArchive) {
                            updatedArchivedExperiments.push(expToArchive);
                        }
                    }

                    return {
                        ...prevData,
                        experiments: updatedExperiments,
                        archivedExperiments: updatedArchivedExperiments,
                    };
                });
            };


            // Function to update experiment name (used by contentEditable)
            const updateExperimentName = (experimentId, newName) => {
                setAppData(prevData => ({
                    ...prevData,
                    experiments: prevData.experiments.map(exp =>
                        exp.id === experimentId ? { ...exp, name: newName } : exp
                    ),
                    archivedExperiments: prevData.archivedExperiments.map(exp =>
                        exp.id === experimentId ? { ...exp, name: newName } : exp
                    ),
                }));
            };

            // Function to open the task modal for adding/editing a task
            const openTaskModal = (experimentId, weekId, task = null) => {
                setCurrentExperimentId(experimentId);
                setCurrentWeekIdForTask(weekId);
                setCurrentTask(task);
                setCurrentTaskTitle(task ? task.title : '');
                setCurrentTaskDescription(task ? task.description : '');
                setCurrentTaskTags(task && task.tags ? task.tags.join(', ') : '');
                setCurrentAttachments(task && task.attachments ? [...task.attachments] : []); // Load existing attachments
                setNewAttachmentUrl(''); // Clear new attachment input
                setNewAttachmentName(''); // Clear new attachment name

                // Set Google Calendar dates/times
                if (task) {
                    setGoogleCalendarStartDate(task.calendarStartDate || '');
                    setGoogleCalendarStartTime(task.calendarStartTime || '');
                    setGoogleCalendarEndDate(task.calendarEndDate || '');
                    setGoogleCalendarEndTime(task.calendarEndTime || '');
                    setIsRecurring(task.isRecurring || false);
                    setRecurrenceType(task.recurrenceType || 'weekly');
                    setRecurrenceEndDate(task.recurrenceEndDate || '');
                } else {
                    // Default to current date/time for new tasks
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    setGoogleCalendarStartDate(`${year}-${month}-${day}`);
                    setGoogleCalendarStartTime(`${hours}:${minutes}`);
                    setGoogleCalendarEndDate(`${year}-${month}-${day}`);
                    setGoogleCalendarEndTime(`${hours}:${minutes}`);
                    setIsRecurring(false);
                    setRecurrenceType('weekly');
                    setRecurrenceEndDate('');
                }

                setSelectedTaskStatus(task ? task.status || 'default' : 'default');
                setShowTaskModal(true);
            };

            // Function to add a new attachment to the current task in the modal
            const addAttachment = () => {
                if (newAttachmentUrl.trim() && newAttachmentName.trim()) {
                    setCurrentAttachments(prev => [...prev, { url: newAttachmentUrl.trim(), name: newAttachmentName.trim() }]);
                    setNewAttachmentUrl('');
                    setNewAttachmentName('');
                } else {
                    alert('אנא הזן גם קישור וגם שם לקובץ המצורף.');
                }
            };

            // Function to remove an attachment from the current task in the modal
            const removeAttachment = (indexToRemove) => {
                setCurrentAttachments(prev => prev.filter((_, index) => index !== indexToRemove));
            };

            // Function to handle saving a task (add or edit)
            const saveTask = (taskDetails, closeModal = true) => {
                const { title, description, tags, attachments, status, calendarStartDate, calendarStartTime, calendarEndDate, calendarEndTime, isRecurring, recurrenceType, recurrenceEndDate } = taskDetails;
                const isNewTask = !currentTask;

                setAppData(prevData => {
                    const updateExperimentTasks = (expList) => expList.map(exp => {
                        if (exp.id === currentExperimentId) {
                            // Create a mutable copy of weeks
                            const updatedWeeks = { ...exp.weeks };

                            // Define the base task data
                            const baseTaskData = {
                                title,
                                description,
                                completed: currentTask ? currentTask.completed : false,
                                status,
                                tags,
                                attachments,
                                calendarStartDate,
                                calendarStartTime,
                                calendarEndDate,
                                calendarEndTime,
                                isRecurring, // Store recurrence info on the original task
                                recurrenceType: isRecurring ? recurrenceType : undefined,
                                recurrenceEndDate: isRecurring ? recurrenceEndDate : undefined,
                            };

                            if (isNewTask) {
                                // Add initial task instance
                                const newTask = { id: `task-${Date.now()}`, ...baseTaskData };
                                updatedWeeks[currentWeekIdForTask] = [...(updatedWeeks[currentWeekIdForTask] || []), newTask];

                                // If recurring, add instances for future weeks
                                if (isRecurring && recurrenceEndDate) {
                                    let currentDate = new Date(currentWeekIdForTask);
                                    const endRecurrenceDate = new Date(recurrenceEndDate);

                                    while (currentDate <= endRecurrenceDate) {
                                        currentDate.setDate(currentDate.getDate() + (recurrenceType === 'bi-weekly' ? 14 : 7)); // Move to next week/bi-week
                                        const nextWeekId = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;

                                        if (currentDate <= endRecurrenceDate) {
                                            // Ensure we don't duplicate the initial task if it falls on the first recurrence interval
                                            if (nextWeekId !== currentWeekIdForTask) {
                                                const recurringTaskInstance = { id: `task-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`, ...baseTaskData };
                                                updatedWeeks[nextWeekId] = [...(updatedWeeks[nextWeekId] || []), recurringTaskInstance];
                                            }
                                        }
                                    }
                                }
                            } else {
                                // Edit existing task
                                const weekTasks = updatedWeeks[currentWeekIdForTask] || [];
                                const taskIndex = weekTasks.findIndex(t => t.id === currentTask.id);
                                if (taskIndex > -1) {
                                    weekTasks[taskIndex] = { ...weekTasks[taskIndex], ...baseTaskData };
                                    updatedWeeks[currentWeekIdForTask] = [...weekTasks]; // Ensure new array for React update
                                }
                            }
                            return {
                                ...exp,
                                weeks: updatedWeeks,
                            };
                        }
                        return exp;
                    });

                    return {
                        ...prevData,
                        experiments: updateExperimentTasks(prevData.experiments),
                        archivedExperiments: updateExperimentTasks(prevData.archivedExperiments),
                    };
                });
                if (closeModal) {
                    setShowTaskModal(false);
                    setCurrentTask(null);
                }
            };

            // Function to delete a specific task
            const deleteTask = (experimentId, weekId, taskIdToDelete) => {
                setConfirmTitle('אישור מחיקת משימה');
                setConfirmMessage('האם אתה בטוח שברצונך למחוק משימה זו? פעולה זו בלתי הפיכה.');
                setConfirmAction(() => () => {
                    setAppData(prevData => {
                        const updateExperimentTasks = (expList) => expList.map(exp => {
                            if (exp.id === experimentId) {
                                const weekTasks = exp.weeks[weekId] || [];
                                return {
                                    ...exp,
                                    weeks: {
                                        ...exp.weeks,
                                        [weekId]: weekTasks.filter(task => task.id !== taskIdToDelete),
                                    },
                                };
                            }
                            return exp;
                        });

                        return {
                            ...prevData,
                            experiments: updateExperimentTasks(prevData.experiments),
                            archivedExperiments: updateExperimentTasks(prevData.archivedExperiments),
                        };
                    });
                    setShowConfirmModal(false);
                });
                setShowConfirmModal(true);
            };

            // Function to toggle task completion
            const toggleTaskCompletion = (experimentId, weekId, taskId) => {
                setAppData(prevData => {
                    const updateExperimentTasks = (expList) => expList.map(exp => {
                        if (exp.id === experimentId) {
                            const weekTasks = exp.weeks[weekId] || [];
                            const updatedTasks = weekTasks.map(task =>
                                task.id === taskId ? { ...task, completed: !task.completed } : task
                            );
                            return {
                                ...exp,
                                weeks: {
                                    ...exp.weeks,
                                    [weekId]: updatedTasks,
                                },
                            };
                        }
                        return exp;
                    });

                    return {
                        ...prevData,
                        experiments: updateExperimentTasks(prevData.experiments),
                        archivedExperiments: updateExperimentTasks(prevData.archivedExperiments),
                    };
                });
            };

            // Function to toggle week column visibility
            const toggleColumnVisibility = (weekId) => {
                setAppData(prevData => ({
                    ...prevData,
                    hiddenColumns: prevData.hiddenColumns.includes(weekId)
                        ? prevData.hiddenColumns.filter(id => id !== weekId)
                        : [...prevData.hiddenColumns, weekId],
                }));
            };

            // Function to open style modal for column or row
            const openStyleModal = (type, id) => {
                setCurrentStyleTarget({ type, id });
                // Set initial color based on existing style
                if (type === 'column' && appData.columnStyles[id]) {
                    setSelectedColor(appData.columnStyles[id].backgroundColor || '#ffffff');
                    setSelectedTextColor(appData.columnStyles[id].textColor || '#000000');
                } else if (type === 'row' && appData.rowStyles[id]) {
                    setSelectedColor(appData.rowStyles[id].backgroundColor || '#ffffff');
                    setSelectedTextColor(appData.rowStyles[id].textColor || '#000000');
                } else {
                    setSelectedColor('#ffffff');
                    setSelectedTextColor('#000000');
                }
                setShowStyleModal(true);
            };

            // Function to apply styles
            const applyStyles = () => {
                const { type, id } = currentStyleTarget;
                setAppData(prevData => {
                    if (type === 'column') {
                        return {
                            ...prevData,
                            columnStyles: {
                                ...prevData.columnStyles,
                                [id]: { backgroundColor: selectedColor, textColor: selectedTextColor },
                            },
                        };
                    } else if (type === 'row') {
                        return {
                            ...prevData,
                            rowStyles: {
                                ...prevData.rowStyles,
                                [id]: { backgroundColor: selectedColor, textColor: selectedTextColor },
                            },
                        };
                    }
                    return prevData;
                });
                setShowStyleModal(false);
            };

            // Function to export table data to Excel (CSV)
            const exportToExcel = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM for Hebrew support

                // Flatten all weeks to get a simple list for headers
                const allFlatWeeks = structuredWeeks.flatMap(year =>
                    year.months.flatMap(month =>
                        month.weeks
                    )
                );

                const headers = ["שם ניסוי", "תיאור ניסוי", "שותפים", ...allFlatWeeks.map(week => week.display)];
                csvContent += headers.join(",") + "\n";

                const experimentsToExport = experimentFilter === 'active' ? appData.experiments :
                                            experimentFilter === 'archived' ? appData.archivedExperiments :
                                            [...appData.experiments, ...appData.archivedExperiments];

                experimentsToExport.forEach(exp => {
                    const row = [
                        `"${exp.name.replace(/"/g, '""')}"`,
                        `"${(exp.description || '').replace(/"/g, '""')}"`,
                        `"${(exp.collaborators || []).join(', ').replace(/"/g, '""')}"`
                    ];
                    allFlatWeeks.forEach(week => {
                        const tasks = exp.weeks[week.id] || [];
                        // Join task titles, excluding completion status and full description
                        const taskTitles = tasks.map(task => task.title).join("; ");
                        row.push(`"${taskTitles.replace(/"/g, '""')}"`);
                    });
                    csvContent += row.join(",") + "\n"; // Quote and escape commas
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "לוח_ניסויים.csv");
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
            };

            // Function to export all app data to JSON
            const exportToJson = () => {
                const dataStr = JSON.stringify({ ...appData, geminiApiKey }, null, 2); // Prettify JSON and include API key
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', 'experiment_board_data.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Function to import all app data from JSON
            const importFromJson = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation for imported data structure
                        if (importedData.experiments && Array.isArray(importedData.experiments) &&
                            importedData.archivedExperiments && Array.isArray(importedData.archivedExperiments) &&
                            importedData.hiddenColumns && Array.isArray(importedData.hiddenColumns)) {
                            setAppData(prevData => {
                                // Ensure aiResponseStyles exists and set default numGuidingQuestions
                                const defaultAiResponseStyles = {
                                    summary: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                                    monthly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                                    weekly: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                                    table: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '' },
                                    experimentDescription: { fontSize: '14px', textColor: '', formulationStyle: 'default', generalInstructions: '', numGuidingQuestions: 3 },
                                };
                                const importedAiResponseStyles = {
                                    ...defaultAiResponseStyles,
                                    ...(importedData.aiResponseStyles || {}),
                                    weekly: {
                                        ...defaultAiResponseStyles.weekly,
                                        ...(importedData.aiResponseStyles?.weekly || {})
                                    },
                                    experimentDescription: {
                                        ...defaultAiResponseStyles.experimentDescription,
                                        ...(importedData.aiResponseStyles?.experimentDescription || {})
                                    }
                                };

                                return {
                                    ...prevData,
                                    ...importedData, // Overwrite existing data with imported data
                                    // Ensure all necessary keys exist even if not in importedData
                                    experiments: (importedData.experiments || []).map(exp => ({
                                        ...exp,
                                        description: exp.description || '',
                                        collaborators: exp.collaborators || [],
                                        attachments: exp.attachments || []
                                    })),
                                    archivedExperiments: (importedData.archivedExperiments || []).map(exp => ({
                                        ...exp,
                                        description: exp.description || '',
                                        collaborators: exp.collaborators || [],
                                        attachments: exp.attachments || []
                                    })),
                                    hiddenColumns: importedData.hiddenColumns || [],
                                    columnStyles: importedData.columnStyles || {},
                                    rowStyles: importedData.rowStyles || {},
                                    darkMode: importedData.darkMode !== undefined ? importedData.darkMode : prevData.darkMode,
                                    aiResponseStyles: importedAiResponseStyles // Use the cleaned styles
                                };
                            });
                            // Set imported API key
                            if (importedData.geminiApiKey) {
                                setGeminiApiKey(importedData.geminiApiKey);
                            } else {
                                setGeminiApiKey(''); // Clear if not present in imported data
                            }
                            alert('הנתונים יובאו בהצלחה!'); // Using alert for simplicity, could be custom modal
                        } else {
                            alert('קובץ JSON אינו בפורמט צפוי. אנא ודא שהקובץ תקין.');
                        }
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        alert('שגיאה בטעינת קובץ JSON. ודא שהפורמט תקין.');
                    }
                };
                reader.readAsText(file);
            };


            // Toggle dark mode
            const toggleDarkMode = () => {
                setAppData(prevData => ({ ...prevData, darkMode: !prevData.darkMode }));
            };

            // LLM Feature: Generate/Refine Task Description
            const handleGenerateDescription = async () => {
                const currentDescription = descriptionTextareaRef.current?.value || ''; // Safely access value
                if (!currentDescription.trim()) {
                    alert('אנא הזן תיאור קיים כדי לשפר אותו.');
                    return;
                }
                if (!geminiApiKey) {
                    alert('אנא הזן את מפתח ה-API של Gemini כדי להשתמש בפונקציות ה-AI.');
                    return;
                }

                const numQuestions = appData.aiResponseStyles.weekly.numGuidingQuestions || 3; // Use configurable number

                if (numQuestions > 0) {
                    setIsGeneratingQuestions(true);

                    // Apply formulation instructions for question generation
                    const formulationInstructions = [];
                    const currentAiStyle = appData.aiResponseStyles.weekly; // Using weekly style as it's for task description
                    if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                        formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                    }
                    if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                        formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                    }
                    const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                    const questionSchema = {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    };
                    const promptForQuestions = `${formulationPrefix}בהתבסס על תיאור המשימה הבא, צור ${numQuestions} שאלות מנחות תמציתיות (עד 20 מילים לשאלה) שיעזרו לדייק ולשפר אותו. השב בפורמט JSON של מערך מחרוזות. השב בעברית.
                    \n\nתיאור המשימה: "${currentDescription}"`;

                    const generatedQuestions = await callGeminiAPI(promptForQuestions, questionSchema);

                    if (generatedQuestions && generatedQuestions.length > 0) {
                        setGuidingQuestions(generatedQuestions);
                        setOriginalDescriptionForRefinement(currentDescription); // Store original description
                        setShowGuidingQuestionsModal(true);
                    } else {
                        alert('ה-AI לא הצליח ליצור שאלות מנחות. אנא נסה שוב.');
                    }
                    setIsGeneratingQuestions(false);
                }
            };

            // Function to refine description after user answers guiding questions
            const handleRefineDescriptionWithAnswers = async (finalAnswers, originalDescription) => {
                setIsRefiningDescription(true);
                setShowGuidingQuestionsModal(false); // Close questions modal

                let answersText = '';
                Object.entries(finalAnswers).forEach(([index, answer]) => {
                    if (guidingQuestions[index] && answer.trim()) { // Use guidingQuestions from state
                        answersText += `שאלה ${parseInt(index) + 1}: ${guidingQuestions[index]}\nתשובה: ${answer}\n`;
                    }
                });

                // Apply formulation instructions to the prompt
                const formulationInstructions = [];
                const currentAiStyle = appData.aiResponseStyles.weekly;
                if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                }
                if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                    formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';


                const promptForRefinement = `${formulationPrefix}בהתבסס על תיאור המשימה המקורי והתשובות לשאלות המנחות, אנא נסח מחדש ושפר את תיאור המשימה. הפוך אותו למפורט יותר, ניתן לפעולה ומקצועי. שמור על תמציתיות, עד 100 מילים. השב בעברית.
                \n\nתיאור מקורי: "${originalDescription}"
                \n\nשאלות ותשובות:
                ${answersText || "אין תשובות נוספות."}`;

                const refinedDescription = await callGeminiAPI(promptForRefinement);

                if (refinedDescription) {
                    // Update currentTaskDescription state, but DO NOT save or close the modal automatically
                    setCurrentTaskDescription(refinedDescription);
                } else {
                    alert('ה-AI לא הצליח לחדד את התיאור עם התשובות. אנא נסה שוב.');
                }
                setIsRefiningDescription(false);
            };

            // Function to refine experiment description after user answers guiding questions
            const handleRefineExperimentDescriptionWithAnswers = async (finalAnswers, originalDescription) => {
                setIsRefiningExperimentDescription(true);
                setShowExperimentGuidingQuestionsModal(false); // Close questions modal

                let answersText = '';
                Object.entries(finalAnswers).forEach(([index, answer]) => {
                    if (experimentGuidingQuestions[index] && answer.trim()) {
                        answersText += `שאלה ${parseInt(index) + 1}: ${experimentGuidingQuestions[index]}\nתשובה: ${answer}\n`;
                    }
                });

                const formulationInstructions = [];
                const currentAiStyle = appData.aiResponseStyles.experimentDescription;
                if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                }
                if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                    formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                const promptForRefinement = `${formulationPrefix}בהתבסס על תיאור הניסוי המקורי והתשובות לשאלות המנחות, אנא נסח מחדש ושפר את תיאור הניסוי. הפוך אותו למפורט יותר, ניתן לפעולה ומקצועי. שמור על תמציתיות, עד 150 מילים. השב בעברית.
                \n\nתיאור מקורי: "${originalDescription}"
                \n\nשאלות ותשובות:
                ${answersText || "אין תשובות נוספות."}`;

                const refinedDescription = await callGeminiAPI(promptForRefinement);

                if (refinedDescription) {
                    // Update the state of the current experiment in the modal, but DO NOT save or close automatically
                    setCurrentExperimentDetails(prevExp => {
                        if (prevExp) {
                            return { ...prevExp, description: refinedDescription };
                        }
                        return prevExp;
                    });
                } else {
                    alert('ה-AI לא הצליח לחדד את תיאור הניסוי עם התשובות. אנא נסה שוב.');
                }
                setIsRefiningExperimentDescription(false);
            };


            // LLM Feature: Generate Experiment Summary
            const handleGenerateExperimentSummary = async (experimentId) => {
                setIsGeneratingSummary(true);
                const experiment = [...appData.experiments, ...appData.archivedExperiments].find(exp => exp.id === experimentId);
                if (!experiment) {
                    setExperimentSummary("שגיאה: ניסוי לא נמצא.");
                    setShowSummaryModal(true);
                    setIsGeneratingSummary(false);
                    return;
                }

                let allTasksText = `ניסוי: ${experiment.name}\n\n`;
                if (experiment.description) {
                    allTasksText += `תיאור ניסוי: ${experiment.description}\n`;
                }
                if (experiment.collaborators && experiment.collaborators.length > 0) {
                    allTasksText += `שותפים: ${experiment.collaborators.join(', ')}\n`;
                }
                allTasksText += `\n`;

                const allExperimentTasks = [];

                // Collect all tasks for this experiment across all weeks
                const allFlatWeeks = structuredWeeks.flatMap(year => year.months.flatMap(month => month.weeks));
                allFlatWeeks.forEach(week => {
                    const tasksInWeek = experiment.weeks[week.id] || [];
                    tasksInWeek.forEach(task => {
                        allExperimentTasks.push({ ...task, weekDisplay: week.display, weekIsoNumber: week.isoWeekNumber });
                    });
                });

                if (allExperimentTasks.length === 0) {
                    setExperimentSummary("אין משימות לניסוי זה כדי לסכם.");
                    setShowSummaryModal(true);
                    setIsGeneratingSummary(false);
                    return;
                }

                allExperimentTasks.forEach(task => {
                    const statusLabel = taskStatusOptions.find(opt => opt.value === task.status)?.label || 'רגיל';
                    const completionStatus = task.completed ? ' (בוצע)' : ' (לא בוצע)';
                    allTasksText += `- שבוע ${task.isoWeekNumber} (${task.weekDisplay}): ${task.title} - ${task.description} [סטטוס: ${statusLabel}${completionStatus}] [תגיות: ${task.tags ? task.tags.join(', ') : 'אין'}]\n`;
                });

                // Apply formulation instructions to the prompt
                const formulationInstructions = [];
                const currentAiStyle = appData.aiResponseStyles.summary;
                if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                }
                if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                    formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                const prompt = `${formulationPrefix}צור סיכום תמציתי ותובנות מעשיות עבור הניסוי הבא, כולל המשימות שלו, תיאור הניסוי ושותפים. הדגש משימות שהושלמו, משימות חשובות, וכל משימה עם סטטוס 'אזהרה'. הצע צעדים ברורים הבאים או בעיות פוטנציאליות בהתבסס על סטטוס המשימות והתיאורים. התמקד בהתקדמות ופעולות עתידיות. שמור על מקצועיות ותמציתיות, עד 250 מילים. השב בעברית:\n\n${allTasksText}`;
                const generatedSummary = await callGeminiAPI(prompt);
                setExperimentSummary(generatedSummary);
                setShowSummaryModal(true);
                setIsGeneratingSummary(false);
            };

            // LLM Feature: Generate Monthly Summary
            const handleGenerateMonthlySummary = async (selectedMonth) => {
                setIsGeneratingMonthlySummary(true);
                setMonthlySummaryContent(''); // Clear previous summary

                const [year, month] = selectedMonth.split('-').map(Number);
                const monthName = new Intl.DateTimeFormat('he-IL', { month: 'long', year: 'numeric' }).format(new Date(year, month - 1, 1));

                let allTasksInMonthText = `סיכום משימות עבור ${monthName}:\n\n`;
                const allMonthlyTasks = [];

                // Iterate through all experiments (active and archived)
                [...appData.experiments, ...appData.archivedExperiments].forEach(exp => {
                    // Iterate through all weeks in the structuredWeeks to find weeks in the selected month
                    structuredWeeks.forEach(yearObj => {
                        yearObj.months.forEach(monthObj => {
                            monthObj.weeks.forEach(week => {
                                const weekDate = new Date(week.date);
                                if (weekDate.getFullYear() === year && (weekDate.getMonth() + 1) === month) {
                                    const tasksInWeek = exp.weeks[week.id] || [];
                                    tasksInWeek.forEach(task => {
                                        allMonthlyTasks.push({ ...task, experimentName: exp.name, weekDisplay: week.display, weekIsoNumber: week.isoWeekNumber });
                                    });
                                }
                            });
                        });
                    });
                });

                if (allMonthlyTasks.length === 0) {
                    setMonthlySummaryContent("אין משימות בחודש זה כדי לסכם.");
                    setIsGeneratingMonthlySummary(false);
                    return;
                }

                allMonthlyTasks.forEach(task => {
                    const statusLabel = taskStatusOptions.find(opt => opt.value === task.status)?.label || 'רגיל';
                    const completionStatus = task.completed ? ' (בוצע)' : ' (לא בוצע)';
                    allTasksInMonthText += `- ניסוי: ${task.experimentName}, שבוע ${task.isoWeekNumber} (${task.weekDisplay}): ${task.title} - ${task.description} [סטטוס: ${statusLabel}${completionStatus}] [תגיות: ${task.tags ? task.tags.join(', ') : 'אין'}]\n`;
                });

                // Apply formulation instructions to the prompt
                const formulationInstructions = [];
                const currentAiStyle = appData.aiResponseStyles.monthly;
                if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                }
                if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                    formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                const prompt = `${formulationPrefix}צור סיכום חודשי תמציתי ותובנות מעשיות עבור המשימות הבאות. הדגש משימות שהושלמו, משימות חשובות, וכל משימה עם סטטוס 'אזהרה'. הצע צעדים ברורים הבאים או בעיות פוטנציאליות בהתבסס על סטטוס המשימות והתיאורים. התמקד בהתקדמות הכוללת ופעולות עתידיות עבור החודש. שמור על מקצועיות ותמציתיות, עד 250 מילים. השב בעברית:\n\n${allTasksInMonthText}`;
                const generatedSummary = await callGeminiAPI(prompt);
                setMonthlySummaryContent(generatedSummary);
                setIsGeneratingMonthlySummary(false);
            };

            // LLM Feature: Generate AI response for the entire table
            const handleGenerateTableAiResponse = async () => {
                if (!tableAiPrompt.trim()) {
                    alert('אנא הזן שאלה או בקשה עבור ה-AI.');
                    return;
                }
                setIsGeneratingTableAi(true);

                let allTableContent = `הטבלה מכילה ניסויים ומשימות שבועיות. הנה המידע המפורט:\n\n`;

                allTableContent += `ניסויים פעילים:\n`;
                appData.experiments.forEach(exp => {
                    allTableContent += `  - ${exp.name} (ID: ${exp.id}): ${exp.description || 'אין תיאור'}\n`;
                    if (exp.collaborators && exp.collaborators.length > 0) {
                        allTableContent += `    שותפים: ${exp.collaborators.join(', ')}\n`;
                    }
                    Object.entries(exp.weeks).forEach(([weekId, tasks]) => {
                        if (tasks.length > 0) {
                            const weekInfo = allFlatWeeks.find(w => w.id === weekId);
                            allTableContent += `    שבוע ${weekInfo ? weekInfo.isoWeekNumber : weekId} (${weekInfo ? weekInfo.display : ''}):\n`;
                            tasks.forEach(task => {
                                const statusLabel = taskStatusOptions.find(opt => opt.value === task.status)?.label || 'רגיל';
                                const completionStatus = task.completed ? ' (בוצע)' : ' (לא בוצע)';
                                allTableContent += `      - ${task.title} (ID: ${task.id}): ${task.description || 'אין תיאור'} [סטטוס: ${statusLabel}${completionStatus}] [תגיות: ${task.tags ? task.tags.join(', ') : 'אין'}]\n`;
                            });
                        }
                    });
                    allTableContent += '\n';
                });

                if (appData.archivedExperiments.length > 0) {
                    allTableContent += `ניסויים בארכיון:\n`;
                    appData.archivedExperiments.forEach(exp => {
                        allTableContent += `  - ${exp.name} (ID: ${exp.id}): ${exp.description || 'אין תיאור'}\n`;
                        // Optionally include archived tasks too, or keep it brief
                    });
                    allTableContent += '\n';
                }

                const aiActionSchema = {
                    type: "OBJECT",
                    properties: {
                        action: { type: "STRING", enum: ["add_task", "edit_task", "delete_task", "add_experiment", "none"], description: "The type of action to perform." },
                        target: {
                            type: "OBJECT",
                            properties: {
                                // For tasks
                                experimentName: { type: "STRING", description: "The name of the experiment to target." },
                                weekId: { type: "STRING", description: "The ID of the week (Sunday date inYYYY-MM-DD format) to target." },
                                taskId: { type: "STRING", description: "The ID of the task to target (required for edit/delete). If adding, this can be a suggested ID or omitted." },
                                taskTitle: { type: "STRING", description: "The title of the task (required for add, optional for edit)." },
                                taskDescription: { type: "STRING", description: "The description of the task (optional for add/edit)." },
                                taskStatus: { type: "STRING", enum: ["default", "important", "completed", "warning", "info"], description: "The status of the task (optional for add/edit)." },
                                taskTags: { type: "ARRAY", items: { type: "STRING" }, description: "Tags for the task (optional for add/edit)." },
                                isCompleted: { type: "BOOLEAN", description: "Whether the task should be marked as completed (optional for add/edit)." },
                                isRecurring: { type: "BOOLEAN", description: "Whether the task is recurring (for add_task)." },
                                recurrenceType: { type: "STRING", enum: ["weekly", "bi-weekly"], description: "Type of recurrence (for add_task if recurring)." },
                                recurrenceEndDate: { type: "STRING", description: "End date for recurrence inYYYY-MM-DD format (for add_task if recurring)." },
                                // For experiments
                                experimentDescription: { type: "STRING", description: "Description for the new experiment." },
                                collaborators: { type: "ARRAY", items: { type: "STRING" }, description: "List of collaborators for the new experiment." },
                                attachments: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            name: { type: "STRING" },
                                            url: { type: "STRING" }
                                        },
                                        required: ["name", "url"]
                                    },
                                    description: "List of attachments for the new experiment."
                                }
                            },
                            // Required fields for specific actions will be handled by AI's understanding
                        },
                        textResponse: { type: "STRING", description: "A natural language response from the AI, explaining the action or providing general information." }
                    },
                    required: ["action", "textResponse"]
                };

                // Apply formulation instructions to the prompt
                const formulationInstructions = [];
                const currentAiStyle = appData.aiResponseStyles.table;
                if (currentAiStyle.formulationStyle && currentAiStyle.formulationStyle !== 'default') {
                    formulationInstructions.push(`השב בסגנון ${currentAiStyle.formulationStyle}.`);
                }
                if (currentAiStyle.generalInstructions && currentAiStyle.generalInstructions.trim()) {
                    formulationInstructions.push(currentAiStyle.generalInstructions.trim());
                }
                const formulationPrefix = formulationInstructions.length > 0 ? `${formulationInstructions.join(' ')} ` : '';

                const promptForAction = `${formulationPrefix}בהתבסס על המידע הבא מהטבלה לניהול ניסויים, אנא נתח את בקשת המשתמש.
                אם הבקשה היא להוסיף, לערוך או למחוק משימה, או להוסיף ניסוי חדש, אנא החזר אובייקט JSON בפורמט שצוין ב-responseSchema.
                אם הבקשה אינה פעולה כזו, הגדר את 'action' כ-'none' וספק 'textResponse' עם התשובה הכללית שלך.

                **הנחיות ספציפיות:**
                - **הוספת משימה (add_task):** אם המשתמש מבקש משימה חוזרת (לדוגמה: "שבוע כן שבוע לא", "כל שבוע", "במשך X שבועות"), הגדר isRecurring ל-true, recurrenceType (weekly/bi-weekly) ו-recurrenceEndDate בתאריך המתאים (חשב אותו מהשבוע הנוכחי אם נתון מספר שבועות).
                - **עריכת/מחיקת משימה (edit_task/delete_task):** נסה לזהות את מזהה המשימה (Task ID) מהטקסט של המשתמש או מהתיאור הקיים. אם לא ניתן לזהות מזהה משימה באופן חד משמעי, השאר את 'taskId' ריק וציין זאת ב-'textResponse'.
                - **הוספת ניסוי (add_experiment):** אם המשתמש מבקש להוסיף ניסוי חדש, מלא את experimentName, experimentDescription, collaborators ו-attachments ככל הניתן מהבקשה.

                **סטטוסים מותרים למשימות:** default, important, completed, warning, info.

                המידע מהטבלה:
                ${allTableContent}

                הבקשה שלי:
                "${tableAiPrompt}"`;

                const aiResponse = await callGeminiAPI(promptForAction, aiActionSchema);

                if (aiResponse && aiResponse.action && aiResponse.action !== 'none') {
                    setAiProposedAction(aiResponse);
                    setShowAiActionConfirmModal(true);
                } else {
                    // If no specific action, just show the text response
                    setTableAiResponse(aiResponse.textResponse || "ה-AI לא זיהה פעולה ספציפית או אירעה שגיאה.");
                    setShowTableAiModal(true);
                }
                setIsGeneratingTableAi(false);
            };

            // New function to apply the AI's proposed action after user confirmation
            const applyAiAction = () => {
                if (!aiProposedAction) return;

                const { action, target } = aiProposedAction;

                setAppData(prevData => {
                    let updatedExperiments = [...prevData.experiments];
                    let updatedArchivedExperiments = [...prevData.archivedExperiments];

                    if (action === 'add_experiment') {
                        const newExperiment = {
                            id: `exp-${Date.now()}`,
                            name: target.experimentName || 'ניסוי חדש',
                            description: target.experimentDescription || '',
                            collaborators: target.collaborators || [],
                            attachments: target.attachments || [],
                            weeks: {}
                        };
                        updatedExperiments.push(newExperiment);
                    } else if (action === 'add_task' || action === 'edit_task' || action === 'delete_task') {
                        const updateExpList = (expList) => expList.map(exp => {
                            // Match experiment by name or ID
                            // Prioritize finding by ID, then by name
                            const targetExperiment = expList.find(e => e.id === target.experimentName) || expList.find(e => e.name === target.experimentName);

                            if (targetExperiment && targetExperiment.id === exp.id) { // Ensure we're modifying the correct experiment object
                                const weekTasks = exp.weeks[target.weekId] || [];
                                let updatedTasks = [...weekTasks];

                                if (action === 'add_task') {
                                    const newTaskBase = {
                                        id: target.taskId || `task-${Date.now()}`, // Use AI's ID or generate new
                                        title: target.taskTitle || 'משימה חדשה',
                                        description: target.taskDescription || '',
                                        completed: target.isCompleted || false,
                                        status: target.taskStatus || 'default',
                                        tags: target.taskTags || [],
                                        attachments: [], // AI won't add attachments for now
                                    };

                                    // Handle recurrence for add_task
                                    if (target.isRecurring && target.recurrenceEndDate) {
                                        let currentDate = new Date(target.weekId);
                                        const endRecurrenceDate = new Date(target.recurrenceEndDate);

                                        while (currentDate <= endRecurrenceDate) {
                                            const recurringTaskInstance = {
                                                id: `task-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`,
                                                ...newTaskBase,
                                                isRecurring: true, // Mark instance as part of recurrence
                                                recurrenceType: target.recurrenceType,
                                                recurrenceEndDate: target.recurrenceEndDate,
                                            };
                                            const currentRecurrenceWeekId = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;

                                            // Only add if the week is within the generated structuredWeeks range
                                            const weekExists = allFlatWeeks.some(w => w.id === currentRecurrenceWeekId);
                                            if (weekExists) {
                                                exp.weeks[currentRecurrenceWeekId] = [...(exp.weeks[currentRecurrenceWeekId] || []), recurringTaskInstance];
                                            }

                                            currentDate.setDate(currentDate.getDate() + (target.recurrenceType === 'bi-weekly' ? 14 : 7)); // Move to next interval
                                        }
                                    } else {
                                        // Add single task if not recurring
                                        updatedTasks.push(newTaskBase);
                                    }
                                } else if (action === 'edit_task') {
                                    // Try to find by ID first, then by title
                                    const taskIndex = updatedTasks.findIndex(t => t.id === target.taskId);
                                    if (taskIndex > -1) {
                                        updatedTasks[taskIndex] = {
                                            ...updatedTasks[taskIndex],
                                            ...(target.taskTitle !== undefined && { title: target.taskTitle }),
                                            ...(target.taskDescription !== undefined && { description: target.taskDescription }),
                                            ...(target.taskStatus !== undefined && { status: target.taskStatus }),
                                            ...(target.taskTags !== undefined && { tags: target.taskTags }),
                                            ...(target.isCompleted !== undefined && { completed: target.isCompleted }),
                                        };
                                    } else {
                                        // If not found by ID, try to find by title if provided
                                        const taskIndexByTitle = updatedTasks.findIndex(t => t.title === target.taskTitle);
                                        if (taskIndexByTitle > -1) {
                                            updatedTasks[taskIndexByTitle] = {
                                                ...updatedTasks[taskIndexByTitle],
                                                ...(target.taskTitle !== undefined && { title: target.taskTitle }),
                                                ...(target.taskDescription !== undefined && { description: target.taskDescription }),
                                                ...(target.taskStatus !== undefined && { status: target.taskStatus }),
                                                ...(target.taskTags !== undefined && { tags: target.taskTags }),
                                                ...(target.isCompleted !== undefined && { completed: target.isCompleted }),
                                            };
                                        } else {
                                            console.warn(`AI requested to edit task, but task with ID "${target.taskId}" or Title "${target.taskTitle}" not found in experiment "${target.experimentName}" week "${target.weekId}".`);
                                        }
                                    }
                                } else if (action === 'delete_task') {
                                    const initialLength = updatedTasks.length;
                                    // Try to delete by ID first, then by title
                                    updatedTasks = updatedTasks.filter(t => t.id !== target.taskId);
                                    if (initialLength === updatedTasks.length) {
                                        updatedTasks = updatedTasks.filter(t => t.title !== target.taskTitle);
                                        if (initialLength === updatedTasks.length) {
                                            console.warn(`AI requested to delete task, but task with ID "${target.taskId}" or Title "${target.taskTitle}" not found in experiment "${target.experimentName}" week "${target.weekId}".`);
                                        }
                                    }
                                }
                                return {
                                    ...exp,
                                    weeks: {
                                        ...exp.weeks,
                                        [target.weekId]: updatedTasks,
                                    },
                                };
                            }
                            return exp;
                        });

                        updatedExperiments = updateExpList(prevData.experiments);
                        updatedArchivedExperiments = updateExpList(prevData.archivedExperiments);
                    }

                    return {
                        ...prevData,
                        experiments: updatedExperiments,
                        archivedExperiments: updatedArchivedExperiments,
                    };
                });

                setShowAiActionConfirmModal(false);
                setAiProposedAction(null);
                // Optionally show a success message
                setTableAiResponse(aiProposedAction.textResponse || "הפעולה בוצעה בהצלחה!");
                setShowTableAiModal(true);
            };

            // Function to save AI response styles
            const handleSaveAiResponseStyles = (component, styles) => {
                setAppData(prevData => ({
                    ...prevData,
                    aiResponseStyles: {
                        ...prevData.aiResponseStyles,
                        [component]: styles
                    }
                }));
            };


            // Function to show tasks for the current week
            const handleShowCurrentWeekTasks = () => {
                const currentWeek = getCurrentWeekId();
                const tasksForCurrentWeek = [];

                [...appData.experiments, ...appData.archivedExperiments].forEach(exp => {
                    const tasksInWeek = exp.weeks[currentWeek] || [];
                    tasksInWeek.forEach(task => {
                        tasksForCurrentWeek.push({ ...task, experimentName: exp.name });
                    });
                });

                // Group tasks by experiment name
                const groupedTasks = tasksForCurrentWeek.reduce((acc, task) => {
                    const expName = task.experimentName || 'ללא ניסוי';
                    if (!acc[expName]) {
                        acc[expName] = [];
                    }
                    acc[expName].push(task);
                    return acc;
                }, {});

                setWeeklyTasksList(groupedTasks); // Store as an object of arrays
                setShowWeeklyTasksModal(true);
            };

            // Function to scroll to the current week column
            const scrollToCurrentWeek = () => {
                if (tableContainerRef.current) {
                    // Find the current week header by ID
                    const currentWeekHeader = tableContainerRef.current.querySelector(`#week-header-${currentWeekId}`);
                    if (currentWeekHeader) {
                        // Calculate scroll position to center the current week
                        const headerRect = currentWeekHeader.getBoundingClientRect();
                        const containerRect = tableContainerRef.current.getBoundingClientRect();
                        const scrollLeft = headerRect.left - containerRect.left + tableContainerRef.current.scrollLeft - (containerRect.width / 2) + (headerRect.width / 2);
                        tableContainerRef.current.scrollTo({
                            left: scrollLeft,
                            behavior: 'smooth'
                        });
                    } else {
                        console.warn("Current week header not found for scrolling:", currentWeekId);
                    }
                }
            };

            // Helper to check if URL is an image
            const isImageUrl = (url) => {
                return /\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url);
            };

            // Function to add a task to Google Calendar
            const addToGoogleCalendar = () => {
                if (!currentTaskTitle) {
                    alert('אנא הזן כותרת למשימה כדי להוסיף אותה ליומן.');
                    return;
                }

                // Format dates and times for Google Calendar URL
                const formatDateTime = (date, time) => {
                    if (!date) return '';
                    const [year, month, day] = date.split('-');
                    const [hours, minutes] = time ? time.split(':') : ['00', '00'];
                    // Google Calendar expectsYYYYMMDDTHHMMSS (no Z for local time, or add Z for UTC)
                    return `${year}${month}${day}T${hours}${minutes}00`;
                };

                const startDateTime = formatDateTime(googleCalendarStartDate, googleCalendarStartTime);
                const endDateTime = formatDateTime(googleCalendarEndDate, googleCalendarEndTime);

                const title = encodeURIComponent(currentTaskTitle);
                const description = encodeURIComponent(currentTaskDescription || '');
                const dates = `${startDateTime}/${endDateTime}`; // Format for Google Calendar

                const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${description}`;

                window.open(googleCalendarUrl, '_blank');
            };

            // Function to navigate to the previous week
            const handlePreviousWeek = () => {
                setTableStartDate(prevDate => {
                    const current = new Date(prevDate);
                    current.setDate(current.getDate() - 7);
                    return current.toISOString().split('T')[0];
                });
            };

            // Function to navigate to the next week
            const handleNextWeek = () => {
                setTableStartDate(prevDate => {
                    const current = new Date(prevDate);
                    current.setDate(current.getDate() + 7);
                    return current.toISOString().split('T')[0];
                });
            };

            // Handle mouse wheel scrolling for week navigation
            const handleWeekScrollWithMouseWheel = (event) => {
                // This function is now attached to the thead, so event.preventDefault() will only apply there.
                event.preventDefault(); // Prevent default page scrolling when over the header

                const scrollAmount = 7; // Scroll by one week

                if (event.deltaY < 0) { // Scrolling up (wheel forward) -> go to previous week
                    setTableStartDate(prevDate => {
                        const current = new Date(prevDate);
                        current.setDate(current.getDate() - scrollAmount);
                        return current.toISOString().split('T')[0];
                    });
                } else if (event.deltaY > 0) { // Scrolling down (wheel backward) -> go to next week
                    setTableStartDate(prevDate => {
                        const current = new Date(prevDate);
                        current.setDate(current.getDate() + 7);
                        return current.toISOString().split('T')[0];
                    });
                }
            };


            // Filtered experiments based on search term and archive status
            const filteredExperiments = React.useMemo(() => {
                let experimentsToDisplay = [];
                if (experimentFilter === 'active') {
                    experimentsToDisplay = appData.experiments;
                } else if (experimentFilter === 'archived') {
                    experimentsToDisplay = appData.archivedExperiments;
                } else { // 'all'
                    experimentsToDisplay = [...appData.experiments, ...appData.archivedExperiments];
                }

                return experimentsToDisplay.filter(exp =>
                    exp.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [appData.experiments, appData.archivedExperiments, experimentFilter, searchTerm]);


            // Pre-compute all flat weeks for efficient rendering in tbody
            const allFlatWeeks = React.useMemo(() => structuredWeeks.flatMap(year =>
                year.months.flatMap(month => month.weeks)
            ), [structuredWeeks]);

            return (
                <div dir="rtl" className={`min-h-screen ${appData.darkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-100 text-gray-900'} font-inter p-2 sm:p-4 md:p-6`}>
                    {/* Header */}
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6 gap-2 sm:gap-4">
                        <h1 className={`text-2xl sm:text-3xl font-bold ${appData.darkMode ? 'text-blue-400' : 'text-blue-700'} text-center sm:text-right w-full sm:w-auto`}>
                            ניהול לוח ניסויים
                        </h1>
                        <div className="flex flex-wrap gap-2 justify-center sm:justify-end w-full sm:w-auto">
                            <button
                                onClick={() => setIsSpecialEditMode(!isSpecialEditMode)}
                                className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md transition-all duration-300
                                    ${isSpecialEditMode ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 dark:focus:ring-blue-600`}
                            >
                                {isSpecialEditMode ? 'צא ממצב עריכה מיוחד' : 'היכנס למצב עריכה מיוחד'}
                            </button>
                            <button
                                onClick={exportToExcel}
                                className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md bg-green-500 hover:bg-green-600 text-white transition-all duration-300
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 dark:focus:ring-green-600`}
                            >
                                ייצוא ל-Excel
                            </button>
                            <button
                                onClick={exportToJson}
                                className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md bg-purple-500 hover:bg-purple-600 text-white transition-all duration-300
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-400 dark:focus:ring-purple-600`}
                            >
                                ייצוא ל-JSON
                            </button>
                            <label className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md bg-purple-500 hover:bg-purple-600 text-white transition-all duration-300 cursor-pointer
                                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-400 dark:focus:ring-purple-600`}>
                                ייבוא מ-JSON
                                <input type="file" accept=".json" onChange={importFromJson} className="hidden" />
                            </label>
                            <button
                                onClick={toggleDarkMode}
                                className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md transition-all duration-300
                                    ${appData.darkMode ? 'bg-yellow-400 hover:bg-yellow-500 text-gray-900' : 'bg-gray-700 hover:bg-gray-800 text-white'}
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 dark:focus:ring-gray-600`}
                            >
                                {appData.darkMode ? 'מצב בהיר ☀️' : 'מצב כהה 🌙'}
                            </button>
                            <button
                                onClick={() => setShowAiConfigModal(true)} // New button for AI config
                                className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md transition-all duration-300
                                    ${appData.darkMode ? 'bg-pink-600 hover:bg-pink-700 text-white' : 'bg-pink-500 hover:bg-pink-600 text-white'}
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-400 dark:focus:ring-pink-600`}
                            >
                                🎨 הגדרות תצוגת AI
                            </button>
                        </div>
                    </div>

                    {/* Controls Section (Date Picker, Search, Filter, API Key, New AI Buttons) */}
                    <div className="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4 sm:mb-6 items-center justify-between">
                        <div className="flex items-center gap-2 w-full sm:w-auto flex-wrap justify-center">
                            <button
                                onClick={handlePreviousWeek}
                                className={`px-2 py-1 text-sm rounded-md shadow-sm ${appData.darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-100' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                &lt; שבוע קודם
                            </button>
                            <label htmlFor="startDatePicker" className="text-xs sm:text-sm font-medium whitespace-nowrap">
                                תאריך התחלה לטבלה:
                            </label>
                            <input
                                type="date"
                                id="startDatePicker"
                                value={tableStartDate}
                                onChange={(e) => setTableStartDate(e.target.value)}
                                className={`p-1 sm:p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-xs sm:text-sm w-full sm:w-auto
                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            />
                            <button
                                onClick={handleNextWeek}
                                className={`px-2 py-1 text-sm rounded-md shadow-sm ${appData.darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-100' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                            >
                                שבוע הבא &gt;
                            </button>
                        </div>
                        <div className="flex items-center gap-2 w-full sm:w-auto">
                            <label htmlFor="experimentSearch" className="sr-only">
                                חיפוש ניסוי:
                            </label>
                            <input
                                type="text"
                                id="experimentSearch"
                                placeholder="חיפוש ניסוי..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className={`w-full p-1 sm:p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            />
                        </div>
                        <div className="flex items-center gap-2 w-full sm:w-auto">
                            <label htmlFor="experimentFilter" className="text-xs sm:text-sm font-medium whitespace-nowrap">
                                הצג ניסויים:
                            </label>
                            <select
                                id="experimentFilter"
                                value={experimentFilter}
                                onChange={(e) => setExperimentFilter(e.target.value)}
                                className={`p-1 sm:p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm w-full sm:w-auto
                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            >
                                <option value="active">פעילים</option>
                                <option value="archived">בארכיון</option>
                                <option value="all">הכל</option>
                            </select>
                        </div>
                        <div className="flex items-center gap-2 w-full sm:w-auto">
                            <label htmlFor="geminiApiKey" className="text-xs sm:text-sm font-medium whitespace-nowrap">
                                מפתח API של Gemini:
                            </label>
                            <input
                                type="password" // Use password type for security
                                id="geminiApiKey"
                                placeholder="הזן מפתח API של Gemini"
                                value={geminiApiKey}
                                onChange={(e) => setGeminiApiKey(e.target.value)}
                                className={`w-full p-1 sm:p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                            />
                        </div>
                    </div>
                    {/* New AI Buttons and Go to Current Week */}
                    <div className="flex flex-wrap gap-2 justify-center sm:justify-start mb-4 sm:mb-6">
                        <button
                            onClick={() => setShowMonthlySummaryModal(true)}
                            disabled={!geminiApiKey}
                            className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md transition-all duration-300
                                ${!geminiApiKey ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}
                                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 dark:focus:ring-indigo-600`}
                        >
                            📊 סיכום חודשי
                        </button>
                        <button
                            onClick={handleShowCurrentWeekTasks}
                            className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md bg-teal-500 hover:bg-teal-600 text-white transition-all duration-300
                                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400 dark:focus:ring-teal-600`}
                        >
                            📋 משימות השבוע
                        </button>
                        <button
                            onClick={scrollToCurrentWeek}
                            className={`px-3 py-1 sm:px-4 sm:py-2 text-sm rounded-lg shadow-md bg-orange-500 hover:bg-orange-600 text-white transition-all duration-300
                                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400 dark:focus:ring-orange-600`}
                        >
                            ➡️ לשבוע הנוכחי
                        </button>
                    </div>

                    {/* API Key instruction */}
                    {!geminiApiKey && (
                        <div className={`mb-4 p-3 rounded-lg shadow-md ${appData.darkMode ? 'bg-yellow-800 text-yellow-100' : 'bg-yellow-100 text-yellow-800'}`}>
                            <p className="text-sm">
                                ⚠️ כדי להשתמש בפונקציות ה-AI (שיפור תיאור וסיכום ניסוי), עליך להזין את מפתח ה-API של Gemini בשדה "מפתח API של Gemini" למעלה.
                                תוכל ליצור מפתח כזה ב- <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="underline hover:text-yellow-900">Google AI Studio</a>.
                                המפתח נשמר באופן מקומי בדפדפן שלך בלבד.
                            </p>
                        </div>
                    )}

                    {/* New AI Interaction for the entire table */}
                    <div className={`mb-4 sm:mb-6 p-3 sm:p-4 rounded-lg shadow-md ${appData.darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                        <h3 className="text-base sm:text-lg font-semibold mb-2">שאלה ל-AI לגבי כל הטבלה:</h3>
                        <textarea
                            rows="3"
                            value={tableAiPrompt}
                            onChange={(e) => setTableAiPrompt(e.target.value)}
                            placeholder="שאל את ה-AI שאלה על הנתונים בטבלה כולה (לדוגמה: 'סכם את המשימות החשובות', 'זהה צווארי בקבוק')... או בקש פעולה: 'הוסף משימה חדשה: לתכנן ניסוי ביוכימי לשבוע הבא בניסוי לדוגמה 1' או 'ערוך משימה לתכנן ניסוי ביוכימי לשבוע הבא בניסוי לדוגמה 1 לסטטוס בוצע' או 'הוסף ניסוי חדש בשם ניסוי חדש לכימיה עם תיאור: ניסוי לבדיקת תרכובות אורגניות'"
                            className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                        ></textarea>
                        <button
                            onClick={handleGenerateTableAiResponse}
                            disabled={isGeneratingTableAi || !tableAiPrompt.trim() || !geminiApiKey}
                            className={`px-3 py-1 sm:px-4 sm:py-2 rounded-lg shadow-md text-sm mt-2 flex items-center justify-center gap-1
                                ${(isGeneratingTableAi || !tableAiPrompt.trim() || !geminiApiKey) ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}
                                transition-colors duration-200`}
                        >
                            {isGeneratingTableAi ? 'יוצר...' : '✨ בקש מה-AI על הטבלה'}
                        </button>
                    </div>


                    {/* Table Container */}
                    <div
                        ref={tableContainerRef}
                        className={`overflow-x-auto rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 ${isSpecialEditMode ? 'special-edit-mode-active' : ''}`}
                    >
                        <table className="w-full border-collapse">
                            {/* Table Header */}
                            <thead
                                ref={tableHeaderRef} // Attach ref to thead
                                onWheel={handleWeekScrollWithMouseWheel} // Apply onWheel here
                                onMouseEnter={() => document.body.style.overflowY = 'hidden'} // Apply onMouseEnter here
                                onMouseLeave={() => document.body.style.overflowY = 'auto'} // Apply onMouseLeave here
                                className={`${appData.darkMode ? 'bg-gray-800 text-gray-200' : 'bg-blue-100 text-blue-800'} sticky top-0`}
                            >
                                {/* Year Row */}
                                <tr>
                                    <th rowSpan="3" className="p-2 sm:p-3 border border-gray-200 dark:border-gray-700 text-right w-32 sm:w-48 min-w-[8rem] sm:min-w-[12rem] sticky right-0 z-20 bg-inherit shadow-sm text-sm sm:text-base">
                                        שם ניסוי / מספר קטלוגי
                                    </th>
                                    {structuredWeeks.map(year => {
                                        // Calculate total visible weeks for the year
                                        const visibleWeeksInYear = year.months.flatMap(month =>
                                            month.weeks.filter(week => !appData.hiddenColumns.includes(week.id))
                                        ).length;

                                        if (visibleWeeksInYear === 0 && !isSpecialEditMode) return null; // Hide year if all its weeks are hidden

                                        return (
                                            <th
                                                key={year.name}
                                                colSpan={isSpecialEditMode ? year.totalWeeks : visibleWeeksInYear}
                                                className={`p-1 sm:p-2 border border-gray-200 dark:border-gray-700 text-center text-base sm:text-lg font-bold
                                                    ${appData.darkMode ? 'bg-gray-700' : 'bg-blue-200'}
                                                `}
                                            >
                                                {year.name}
                                            </th>
                                        );
                                    })}
                                </tr>
                                {/* Month Row */}
                                <tr>
                                    {structuredWeeks.map(year => {
                                        return year.months.map(month => {
                                            // Calculate total visible weeks for the month
                                            const visibleWeeksInMonth = month.weeks.filter(week => !appData.hiddenColumns.includes(week.id)).length;

                                            if (visibleWeeksInMonth === 0 && !isSpecialEditMode) return null; // Hide month if all its weeks are hidden

                                            return (
                                                <th
                                                    key={`${year.name}-${month.name}`}
                                                    colSpan={isSpecialEditMode ? month.totalWeeks : visibleWeeksInMonth}
                                                    className={`p-1 sm:p-2 border border-gray-200 dark:border-gray-700 text-center font-semibold text-sm sm:text-base
                                                        ${appData.darkMode ? 'bg-gray-700' : 'bg-blue-200'}
                                                    `}
                                                >
                                                    {month.name}
                                                </th>
                                            );
                                        });
                                    })}
                                </tr>
                                {/* Week Row */}
                                <tr>
                                    {structuredWeeks.map(year => {
                                        return year.months.map(month => {
                                            return month.weeks.map(week => {
                                                const isHidden = appData.hiddenColumns.includes(week.id);
                                                const isCurrentWeek = week.id === currentWeekId;
                                                const columnStyle = appData.columnStyles[week.id] || {};

                                                if (isHidden && !isSpecialEditMode) return null; // Hide completely if not in edit mode

                                                return (
                                                    <th
                                                        key={week.id}
                                                        id={`week-header-${week.id}`}
                                                        className={`p-2 sm:p-3 border border-gray-200 dark:border-gray-700 text-center relative w-24 sm:w-28 min-w-[6rem] sm:min-w-[7rem]
                                                            ${isCurrentWeek ? 'border-2 sm:border-4 border-red-500' : ''}
                                                            ${isHidden && isSpecialEditMode ? 'opacity-50' : ''}
                                                            ${appData.darkMode ? 'bg-gray-800' : 'bg-blue-100'}
                                                        `}
                                                        style={{
                                                            backgroundColor: columnStyle.backgroundColor,
                                                            color: columnStyle.textColor,
                                                            fontSize: columnStyle.fontSize,
                                                            fontFamily: columnStyle.fontFamily,
                                                        }}
                                                    >
                                                        <div className="flex flex-col items-center text-xs sm:text-sm">
                                                            <span>שבוע-{week.isoWeekNumber}</span>
                                                            <span>{week.display}</span>
                                                        </div>
                                                        {isSpecialEditMode && (
                                                            <div className="absolute top-0.5 left-0.5 flex gap-0.5">
                                                                {/* Ghost icon for hide/show column */}
                                                                <button
                                                                    onClick={() => toggleColumnVisibility(week.id)}
                                                                    title={isHidden ? 'הצג עמודה' : 'הסתר עמודה'}
                                                                    className="p-0.5 rounded-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs"
                                                                >
                                                                    {isHidden ? '👻' : '👁️'}
                                                                </button>
                                                                {/* Paintbrush icon for column styling */}
                                                                <button
                                                                    onClick={() => openStyleModal('column', week.id)}
                                                                    title="עצב עמודה"
                                                                    className="p-0.5 rounded-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs"
                                                                >
                                                                    🎨
                                                                </button>
                                                            </div>
                                                        )}
                                                    </th>
                                                );
                                            });
                                        });
                                    })}
                                </tr>
                            </thead>
                            {/* Table Body */}
                            <tbody>
                                {filteredExperiments.length === 0 ? (
                                    <tr>
                                        <td colSpan={allFlatWeeks.length + 1} className="p-4 text-center text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-gray-700 text-sm">
                                            {searchTerm ? 'לא נמצאו ניסויים התואמים לחיפוש.' : 'אין ניסויים להצגה. לחץ על ➕ כדי להוסיף ניסוי חדש.'}
                                        </td>
                                    </tr>
                                ) : (
                                    filteredExperiments.map(experiment => {
                                        const rowStyle = appData.rowStyles[experiment.id] || {};
                                        const isArchived = appData.archivedExperiments.some(exp => exp.id === experiment.id);

                                        return (
                                            <tr
                                                key={experiment.id}
                                                className={`${appData.darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white hover:bg-gray-50'} transition-colors duration-200`}
                                                style={{
                                                    backgroundColor: rowStyle.backgroundColor,
                                                    color: rowStyle.textColor,
                                                }}
                                            >
                                                {/* Experiment Name Cell */}
                                                <td
                                                    className={`p-2 sm:p-3 border border-gray-200 dark:border-gray-700 text-right relative sticky right-0 z-0
                                                    ${appData.darkMode ? 'bg-gray-700' : 'bg-white'}
                                                    ${isSpecialEditMode ? 'shadow-md' : ''}
                                                    ${isArchived ? 'opacity-70 italic' : ''}
                                                    `}
                                                    onMouseEnter={() => setHoveredExperimentId(experiment.id)}
                                                    onMouseLeave={() => setHoveredExperimentId(null)}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div
                                                            contentEditable={true}
                                                            onBlur={(e) => updateExperimentName(experiment.id, e.target.innerText)}
                                                            className="flex-grow focus:outline-none focus:ring-1 focus:ring-blue-400 rounded-md p-0.5 -m-0.5 text-sm sm:text-base"
                                                            suppressContentEditableWarning={true}
                                                        >
                                                            {experiment.name}
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                setCurrentExperimentDetails(experiment);
                                                                setShowExperimentDetailsModal(true);
                                                            }}
                                                            title="ערוך פרטי ניסוי"
                                                            className="p-1 rounded-full bg-blue-300 dark:bg-blue-600 hover:bg-blue-400 dark:hover:bg-blue-500 text-blue-700 dark:text-blue-200 text-xs sm:text-sm ml-1"
                                                        >
                                                            ✏️
                                                        </button>
                                                    </div>
                                                    {isSpecialEditMode && (
                                                        <div className="absolute top-0.5 left-0.5 flex gap-0.5">
                                                            {/* Trash icon for deleting experiment */}
                                                            <button
                                                                onClick={() => deleteExperiment(experiment.id)}
                                                                title="מחק ניסוי"
                                                                className="p-0.5 rounded-full bg-red-300 dark:bg-red-600 hover:bg-red-400 dark:hover:bg-red-500 text-red-700 dark:text-red-200 text-xs"
                                                            >
                                                                🗑️
                                                            </button>
                                                            {/* Archive/Restore icon for experiment */}
                                                            <button
                                                                onClick={() => toggleArchiveExperiment(experiment.id, isArchived)}
                                                                title={isArchived ? 'שחזר ניסוי' : 'העבר לארכיון'}
                                                                className={`p-0.5 rounded-full shadow-sm text-xs
                                                                    ${isArchived ? 'bg-green-300 hover:bg-green-400 text-green-700' : 'bg-yellow-300 hover:bg-yellow-400 text-yellow-700'}`}
                                                            >
                                                                {isArchived ? '📂' : '📦'}
                                                            </button>
                                                            {/* Gemini LLM Feature: Experiment Summary Button */}
                                                            <button
                                                                onClick={() => handleGenerateExperimentSummary(experiment.id)}
                                                                title="צור סיכום ניסוי באמצעות AI"
                                                                disabled={isGeneratingSummary || !geminiApiKey}
                                                                className={`p-0.5 rounded-full shadow-sm text-xs flex items-center justify-center gap-0.5
                                                                    ${(isGeneratingSummary || !geminiApiKey) ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600 text-white'}
                                                                    transition-colors duration-200`}
                                                            >
                                                                {isGeneratingSummary ? 'יוצר...' : '✨ סיכום ניסוי'}
                                                            </button>
                                                        </div>
                                                    )}
                                                    {(hoveredExperimentId === experiment.id || isSpecialEditMode) && experiment.description && (
                                                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-0.5 max-h-16 overflow-y-auto no-scrollbar">
                                                            {experiment.description}
                                                        </p>
                                                    )}
                                                    {experiment.collaborators && experiment.collaborators.length > 0 && (
                                                        <p className="text-xs text-gray-500 dark:text-gray-300 mt-0.5">
                                                            שותפים: {experiment.collaborators.join(', ')}
                                                        </p>
                                                    )}
                                                    {experiment.attachments && experiment.attachments.length > 0 && (
                                                        <div className="flex flex-wrap gap-0.5 mt-0.5">
                                                            {experiment.attachments.map((att, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        if (isImageUrl(att.url)) {
                                                                            setImageToView(att.url);
                                                                            setShowImageViewerModal(true);
                                                                        } else {
                                                                            window.open(att.url, '_blank');
                                                                        }
                                                                    }}
                                                                    title={att.name}
                                                                    className={`text-xs px-1 py-0.5 rounded-full flex items-center gap-0.5
                                                                        ${appData.darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-800 hover:bg-gray-400'}`}
                                                                >
                                                                    {isImageUrl(att.url) ? '🖼️' : '🔗'} {att.name}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </td>
                                                {/* Week Cells */}
                                                {allFlatWeeks.map(week => {
                                                    const isHidden = appData.hiddenColumns.includes(week.id);
                                                    const columnStyle = appData.columnStyles[week.id] || {};
                                                    const tasks = experiment.weeks[week.id] || [];
                                                    const completedTasksCount = tasks.filter(t => t.completed).length;

                                                    if (isHidden && !isSpecialEditMode) return null;

                                                    return (
                                                        <td
                                                            key={week.id}
                                                            className={`p-1 sm:p-2 border border-gray-200 dark:border-gray-700 align-top relative
                                                                ${isHidden && !isSpecialEditMode ? 'hidden' : ''}
                                                                ${isHidden && isSpecialEditMode ? 'opacity-50' : ''}
                                                            `}
                                                            style={{
                                                                backgroundColor: columnStyle.backgroundColor || rowStyle.backgroundColor,
                                                                color: columnStyle.textColor || rowStyle.textColor,
                                                            }}
                                                        >
                                                            {/* Add Task button and task count at the top */}
                                                            <div className="flex justify-between items-center mb-1">
                                                                <button
                                                                    onClick={() => openTaskModal(experiment.id, week.id)}
                                                                    title="הוסף משימה"
                                                                    className={`w-6 h-6 sm:w-7 sm:h-7 rounded-full shadow-md flex items-center justify-center text-base sm:text-lg
                                                                        ${appData.darkMode ? 'bg-blue-700 hover:bg-blue-800 text-white' : 'bg-blue-200 hover:bg-blue-300 text-blue-700'}
                                                                        transition-colors duration-200`}
                                                                >
                                                                    ➕
                                                                </button>
                                                                {tasks.length > 0 && (
                                                                    <div className={`text-xs sm:text-sm text-center ${appData.darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                                                        {completedTasksCount}/{tasks.length} משימות
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* This div now wraps all tasks and allows vertical expansion */}
                                                            <div className="flex flex-col gap-1 flex-grow">
                                                                {tasks.map(task => {
                                                                    const statusClasses = taskStatusOptions.find(opt => opt.value === task.status) || taskStatusOptions[0];
                                                                    return (
                                                                        <div
                                                                            key={task.id}
                                                                            // Added group for tooltip functionality
                                                                            className={`flex items-center gap-1 px-1 py-0.5 rounded-md transition-colors duration-200 flex-shrink-0
                                                                                ${statusClasses.bgColorClass} ${statusClasses.textColorClass}
                                                                                ${task.completed ? 'line-through opacity-70' : ''}
                                                                                group relative`}
                                                                            onMouseEnter={(e) => {
                                                                                const targetRect = e.currentTarget.getBoundingClientRect();
                                                                                setTooltipPosition({
                                                                                    x: targetRect.right + 10,
                                                                                    y: targetRect.top + window.scrollY + targetRect.height / 2
                                                                                });
                                                                                setTooltipContent(task.description);
                                                                                setTooltipTimeout(setTimeout(() => {
                                                                                    setShowTooltip(true);
                                                                                }, 1000)); // 1 second delay
                                                                            }}
                                                                            onMouseLeave={() => {
                                                                                clearTimeout(tooltipTimeout);
                                                                                setShowTooltip(false);
                                                                                setTooltipContent('');
                                                                            }}
                                                                        >
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={task.completed}
                                                                                onChange={() => toggleTaskCompletion(experiment.id, week.id, task.id)}
                                                                                className="form-checkbox h-3 w-3 sm:h-4 sm:w-4 text-blue-600 rounded"
                                                                            />
                                                                            <span className={`flex-grow text-xs sm:text-sm font-semibold mr-1 sm:mr-2 max-w-full`}>
                                                                                {task.title} {/* Display task title */}
                                                                            </span>
                                                                            <div className="flex items-center gap-0.5">
                                                                                {/* Edit Task Button */}
                                                                                <button
                                                                                    onClick={() => openTaskModal(experiment.id, week.id, task)}
                                                                                    title="ערוך משימה"
                                                                                    className="text-gray-500 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-xs sm:text-sm"
                                                                                >
                                                                                    ✏️
                                                                                </button>
                                                                                {/* Delete Task Button */}
                                                                                <button
                                                                                    onClick={() => deleteTask(experiment.id, week.id, task.id)}
                                                                                    title="מחק משימה"
                                                                                    className="text-red-500 dark:text-red-300 hover:text-red-700 dark:hover:text-red-400 text-xs sm:text-sm"
                                                                                >
                                                                                    🗑️
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Add Experiment Button (Floating) */}
                    <button
                        onClick={addExperiment}
                        className={`fixed bottom-4 right-4 p-3 sm:p-4 rounded-full shadow-lg text-white text-2xl sm:text-3xl z-40
                            ${appData.darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'}
                            transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 dark:focus:ring-blue-600`}
                        title="הוסף ניסוי חדש"
                    >
                        ➕
                    </button>

                    {/* Task Modal */}
                    {showTaskModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div
                                ref={taskModalRef}
                                className={`rounded-lg p-4 sm:p-6 shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto no-scrollbar
                                ${appData.darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}
                            >
                                <h2 className="text-lg sm:text-xl font-semibold mb-4">
                                    {currentTask ? 'ערוך משימה' : 'הוסף משימה חדשה'}
                                </h2>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    saveTask({
                                        title: currentTaskTitle,
                                        description: currentTaskDescription,
                                        tags: currentTaskTags.split(',').map(tag => tag.trim()).filter(tag => tag !== ''),
                                        attachments: currentAttachments,
                                        status: selectedTaskStatus,
                                        calendarStartDate: googleCalendarStartDate,
                                        calendarStartTime: googleCalendarStartTime,
                                        calendarEndDate: googleCalendarEndDate,
                                        calendarEndTime: googleCalendarEndTime,
                                        isRecurring,
                                        recurrenceType,
                                        recurrenceEndDate,
                                    }, true); // Pass true to close the modal after manual save
                                }}>
                                    <div className="mb-3 sm:mb-4">
                                        <label htmlFor="taskTitle" className="block text-sm font-medium mb-1">
                                            כותרת משימה:
                                        </label>
                                        <input
                                            type="text"
                                            id="taskTitle"
                                            name="title"
                                            value={currentTaskTitle}
                                            onChange={(e) => setCurrentTaskTitle(e.target.value)}
                                            className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                            required
                                        />
                                    </div>
                                    <div className="mb-3 sm:mb-4">
                                        <label htmlFor="description" className="block text-sm font-medium mb-1">
                                            תיאור משימה:
                                        </label>
                                        <textarea
                                            id="description"
                                            name="description"
                                            rows="4"
                                            value={currentTaskDescription}
                                            onChange={(e) => setCurrentTaskDescription(e.target.value)}
                                            className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                            ref={descriptionTextareaRef} // Attach ref here
                                        ></textarea>
                                        {/* Gemini LLM Feature: Refine Description Button */}
                                        <button
                                            type="button"
                                            onClick={handleGenerateDescription}
                                            disabled={isGeneratingDescription || isGeneratingQuestions || isRefiningDescription || !geminiApiKey}
                                            className={`px-3 py-1 rounded-lg shadow-sm text-xs sm:text-sm mt-2 flex items-center justify-center gap-1
                                                ${(isGeneratingDescription || isGeneratingQuestions || isRefiningDescription || !geminiApiKey) ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600 text-white'}
                                                transition-colors duration-200`}
                                        >
                                            {isGeneratingQuestions ? 'יוצר שאלות...' : isRefiningDescription ? 'מחדד תיאור...' : isGeneratingDescription ? 'משפר תיאור...' : '✨ שפר תיאור'}
                                        </button>
                                    </div>
                                    <div className="mb-3 sm:mb-4">
                                        <label htmlFor="taskTags" className="block text-sm font-medium mb-1">
                                            תגיות (מופרדות בפסיקים):
                                        </label>
                                        <input
                                            type="text"
                                            id="taskTags"
                                            name="tags"
                                            value={currentTaskTags}
                                            onChange={(e) => setCurrentTaskTags(e.target.value)}
                                            className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                            placeholder="לדוגמה: דחוף, מעבדה, ריאגנטים"
                                        />
                                    </div>
                                    <div className="mb-3 sm:mb-4">
                                        <label htmlFor="taskStatus" className="block text-sm font-medium mb-1">
                                            סטטוס משימה:
                                        </label>
                                        <select
                                            id="taskStatus"
                                            value={selectedTaskStatus}
                                            onChange={(e) => setSelectedTaskStatus(e.target.value)}
                                            className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                        >
                                            {taskStatusOptions.map(option => (
                                                <option key={option.value} value={option.value}>
                                                    {option.label}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Recurrence Section */}
                                    <div className="mb-3 sm:mb-4 p-3 border rounded-md ${appData.darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'}">
                                        <h3 className="text-base sm:text-md font-semibold mb-2">חזרה על משימה</h3>
                                        <div className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                id="isRecurring"
                                                checked={isRecurring}
                                                onChange={(e) => setIsRecurring(e.target.checked)}
                                                className="form-checkbox h-4 w-4 text-blue-600 rounded"
                                            />
                                            <label htmlFor="isRecurring" className="mr-2 text-sm">משימה חוזרת</label>
                                        </div>
                                        {isRecurring && (
                                            <>
                                                <div className="mb-2">
                                                    <label htmlFor="recurrenceType" className="block text-xs font-medium mb-1">
                                                        תדירות:
                                                    </label>
                                                    <select
                                                        id="recurrenceType"
                                                        value={recurrenceType}
                                                        onChange={(e) => setRecurrenceType(e.target.value)}
                                                        className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                            ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`}
                                                    >
                                                        <option value="weekly">שבועית</option>
                                                        <option value="bi-weekly">דו-שבועית (שבוע כן שבוע לא)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label htmlFor="recurrenceEndDate" className="block text-xs font-medium mb-1">
                                                        תאריך סיום חזרה:
                                                    </label>
                                                    <input
                                                        type="date"
                                                        id="recurrenceEndDate"
                                                        value={recurrenceEndDate}
                                                        onChange={(e) => setRecurrenceEndDate(e.target.value)}
                                                        className={`w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm
                                                            ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`}
                                                    />
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    {/* Attachments Section */}
                                    <div className="mb-3 sm:mb-4">
                                        <label className="block text-sm font-medium mb-2">קבצים מצורפים (קישורים):</label>
                                        <div className="flex flex-col gap-2 mb-2">
                                            {currentAttachments.map((att, index) => (
                                                <div key={index} className={`flex items-center justify-between p-2 rounded-md
                                                    ${appData.darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                                    <span className="text-xs sm:text-sm truncate">{att.name} ({att.url})</span>
                                                    <button
                                                        type="button"
                                                        onClick={() => removeAttachment(index)}
                                                        className="text-red-500 hover:text-red-700 text-base"
                                                        title="מחק קובץ מצורף"
                                                    >
                                                        &times;
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                            <input
                                                type="text"
                                                placeholder="שם קובץ"
                                                value={newAttachmentName}
                                                onChange={(e) => setNewAttachmentName(e.target.value)}
                                                className={`flex-grow p-2 border rounded-md text-sm w-full sm:w-auto
                                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                            />
                                            <input
                                                type="url"
                                                placeholder="קישור לקובץ/תמונה (URL)"
                                                value={newAttachmentUrl}
                                                onChange={(e) => setNewAttachmentUrl(e.target.value)}
                                                className={`flex-grow p-2 border rounded-md text-sm w-full sm:w-auto
                                                    ${appData.darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-gray-50 border-gray-300 text-gray-900'}`}
                                            />
                                            <button
                                                type="button"
                                                onClick={addAttachment}
                                                className={`px-3 py-1 rounded-lg shadow-sm text-sm w-full sm:w-auto
                                                    ${appData.darkMode ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                                            >
                                                הוסף
                                            </button>
                                        </div>
                                        <p className="text-xs text-gray-500 dark:text-gray-400">
                                            *הערה: אין אפשרות להעלות קבצים ישירות ללא שרת. ניתן לצרף קישורים לקבצים קיימים ברשת (כמו תמונות, מסמכים ב-Google Drive וכו').
                                        </p>
                                    </div>

                                    {/* Google Calendar Section */}
                                    <div className="mb-3 sm:mb-4 p-3 border rounded-md ${appData.darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'}">
                                        <h3 className="text-base sm:text-md font-semibold mb-2">הוסף ליומן גוגל</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                                            <div>
                                                <label htmlFor="calStartDate" className="block text-xs font-medium mb-1">תאריך התחלה:</label>
                                                <input type="date" id="calStartDate" value={googleCalendarStartDate} onChange={(e) => setGoogleCalendarStartDate(e.target.value)}
                                                    className={`w-full p-1 border rounded-md text-sm ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`} />
                                            </div>
                                            <div>
                                                <label htmlFor="calStartTime" className="block text-xs font-medium mb-1">שעת התחלה:</label>
                                                <input type="time" id="calStartTime" value={googleCalendarStartTime} onChange={(e) => setGoogleCalendarStartTime(e.target.value)}
                                                    className={`w-full p-1 border rounded-md text-sm ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`} />
                                            </div>
                                            <div>
                                                <label htmlFor="calEndDate" className="block text-xs font-medium mb-1">תאריך סיום:</label>
                                                <input type="date" id="calEndDate" value={googleCalendarEndDate} onChange={(e) => setGoogleCalendarEndDate(e.target.value)}
                                                    className={`w-full p-1 border rounded-md text-sm ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`} />
                                            </div>
                                            <div>
                                                <label htmlFor="calEndTime" className="block text-xs font-medium mb-1">שעת סיום:</label>
                                                <input type="time" id="calEndTime" value={googleCalendarEndTime} onChange={(e) => setGoogleCalendarEndTime(e.target.value)}
                                                    className={`w-full p-1 border rounded-md text-sm ${appData.darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'}`} />
                                            </div>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={addToGoogleCalendar}
                                            className={`w-full px-4 py-2 rounded-lg shadow-md text-sm mt-3
                                                ${appData.darkMode ? 'bg-orange-600 hover:bg-orange-700 text-white' : 'bg-orange-500 hover:bg-orange-600 text-white'}`}
                                        >
                                            הוסף ליומן גוגל
                                        </button>
                                    </div>


                                    <div className="flex justify-end gap-3">
                                        <button
                                            type="button"
                                            onClick={() => setShowTaskModal(false)}
                                            className={`px-4 py-2 rounded-lg shadow-md text-sm
                                                ${appData.darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}
                                                ${(isGeneratingDescription || isGeneratingQuestions || isRefiningDescription) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            disabled={isGeneratingDescription || isGeneratingQuestions || isRefiningDescription}
                                        >
                                            ביטול
                                        </button>
                                        <button
                                            type="submit"
                                            className={`px-4 py-2 rounded-lg shadow-md text-sm
                                                ${appData.darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}
                                                ${(isGeneratingDescription || isGeneratingQuestions || isRefiningDescription) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            disabled={isGeneratingDescription || isGeneratingQuestions || isRefiningDescription}
                                        >
                                            שמור
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Style Modal */}
                    {showStyleModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div ref={styleModalRef} className={`rounded-lg p-4 sm:p-6 shadow-xl w-full max-w-sm
                                ${appData.darkMode ? 'bg-gray-800 text-gray-100' : 'bg-white text-gray-900'}`}>
                                <h2 className="text-lg sm:text-xl font-semibold mb-4">
                                    עצב {currentStyleTarget.type === 'column' ? 'עמודה' : 'שורה'}
                                </h2>
                                <div className="mb-3 sm:mb-4">
                                    <label htmlFor="bgColor" className="block text-sm font-medium mb-1">
                                        צבע רקע:
                                    </label>
                                    <input
                                        type="color"
                                        id="bgColor"
                                        value={selectedColor}
                                        onChange={(e) => setSelectedColor(e.target.value)}
                                        className="w-full h-8 sm:h-10 rounded-md border-gray-300 dark:border-gray-600"
                                    />
                                </div>
                                <div className="mb-3 sm:mb-4">
                                    <label htmlFor="textColor" className="block text-sm font-medium mb-1">
                                        צבע טקסט:
                                    </label>
                                    <input
                                        type="color"
                                        id="textColor"
                                        value={selectedTextColor}
                                        onChange={(e) => setSelectedTextColor(e.target.value)}
                                        className="w-full h-8 sm:h-10 rounded-md border-gray-300 dark:border-gray-600"
                                    />
                                </div>
                                {/* Font size/type options could be added here if needed */}
                                <div className="flex justify-end gap-3">
                                    <button
                                        type="button"
                                        onClick={() => setShowStyleModal(false)}
                                        className={`px-4 py-2 rounded-lg shadow-md text-sm
                                            ${appData.darkMode ? 'bg-gray-600 hover:bg-gray-700 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                    >
                                        ביטול
                                    </button>
                                    <button
                                        type="button"
                                        onClick={applyStyles}
                                        className={`px-4 py-2 rounded-lg shadow-md text-sm
                                            ${appData.darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                                    >
                                        החל
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Experiment Summary Modal */}
                    <SummaryModal
                        show={showSummaryModal}
                        onClose={() => setShowSummaryModal(false)}
                        title="סיכום ניסוי מבוסס AI"
                        content={experimentSummary}
                        darkMode={appData.darkMode}
                        aiResponseStyle={appData.aiResponseStyles.summary}
                    />

                    {/* Monthly Summary Modal */}
                    <MonthlySummaryModal
                        show={showMonthlySummaryModal}
                        onClose={() => setShowMonthlySummaryModal(false)}
                        onGenerate={handleGenerateMonthlySummary}
                        summaryContent={monthlySummaryContent}
                        isGenerating={isGeneratingMonthlySummary}
                        darkMode={appData.darkMode}
                        aiResponseStyle={appData.aiResponseStyles.monthly}
                    />

                    {/* Weekly Tasks Modal */}
                    <WeeklyTasksModal
                        show={showWeeklyTasksModal}
                        onClose={() => setShowWeeklyTasksModal(false)}
                        tasks={weeklyTasksList}
                        darkMode={appData.darkMode}
                        callGeminiAPI={callGeminiAPI} // Pass the API function
                        taskStatusOptions={taskStatusOptions} // Pass status options
                        aiResponseStyle={appData.aiResponseStyles.weekly}
                    />

                    {/* Image Viewer Modal */}
                    <ImageViewerModal
                        show={showImageViewerModal}
                        onClose={() => setShowImageViewerModal(false)}
                        imageUrl={imageToView}
                        darkMode={appData.darkMode}
                    />

                    {/* Confirmation Modal */}
                    <ConfirmationModal
                        show={showConfirmModal}
                        onClose={() => setShowConfirmModal(false)}
                        onConfirm={confirmAction}
                        title={confirmTitle}
                        message={confirmMessage}
                        darkMode={appData.darkMode}
                    />

                    {/* Experiment Details Modal */}
                    <ExperimentDetailsModal
                        show={showExperimentDetailsModal}
                        onClose={() => setShowExperimentDetailsModal(false)}
                        onSave={saveExperiment}
                        initialExperiment={currentExperimentDetails}
                        darkMode={appData.darkMode}
                        callGeminiAPI={callGeminiAPI} // Pass API function
                        geminiApiKey={geminiApiKey} // Pass API key
                        aiResponseStyles={appData.aiResponseStyles} // Pass all AI styles
                        setShowExperimentGuidingQuestionsModal={setShowExperimentGuidingQuestionsModal}
                        setExperimentGuidingQuestions={setExperimentGuidingQuestions}
                        setOriginalExperimentDescriptionForRefinement={setOriginalExperimentDescriptionForRefinement}
                        isGeneratingExperimentQuestions={isGeneratingExperimentQuestions} // Pass state directly
                        isRefiningExperimentDescription={isRefiningExperimentDescription} // Pass state directly
                        setIsGeneratingExperimentQuestions={setIsGeneratingExperimentQuestions}
                        setIsRefiningExperimentDescription={setIsRefiningExperimentDescription}
                    />

                    {/* Table AI Response Modal */}
                    <TableAiResponseModal
                        show={showTableAiModal}
                        onClose={() => setShowTableAiModal(false)}
                        title="תשובת AI על הטבלה"
                        content={tableAiResponse}
                        darkMode={appData.darkMode}
                        aiResponseStyle={appData.aiResponseStyles.table}
                    />

                    {/* AI Action Confirmation Modal */}
                    <AiActionConfirmationModal
                        show={showAiActionConfirmModal}
                        onClose={() => setShowAiActionConfirmModal(false)}
                        onConfirm={applyAiAction}
                        aiResponse={aiProposedAction}
                        darkMode={appData.darkMode}
                    />

                    {/* AI Response Configuration Modal */}
                    <AiResponseConfigModal
                        show={showAiConfigModal}
                        onClose={() => setShowAiConfigModal(false)}
                        aiResponseStyles={appData.aiResponseStyles}
                        onSaveStyles={handleSaveAiResponseStyles}
                        darkMode={appData.darkMode}
                    />

                    {/* Guiding Questions Modal for Task Description */}
                    <GuidingQuestionsModal
                        show={showGuidingQuestionsModal}
                        onClose={() => setShowGuidingQuestionsModal(false)}
                        questions={guidingQuestions}
                        onComplete={handleRefineDescriptionWithAnswers}
                        originalDescription={originalDescriptionForRefinement} // Pass original description here
                        darkMode={appData.darkMode}
                        aiResponseStyle={appData.aiResponseStyles.weekly} // Use weekly style for questions
                    />

                    {/* Guiding Questions Modal for Experiment Description */}
                    <GuidingQuestionsModal
                        show={showExperimentGuidingQuestionsModal}
                        onClose={() => setShowExperimentGuidingQuestionsModal(false)}
                        questions={experimentGuidingQuestions}
                        onComplete={handleRefineExperimentDescriptionWithAnswers}
                        originalDescription={originalExperimentDescriptionForRefinement}
                        darkMode={appData.darkMode}
                        aiResponseStyle={appData.aiResponseStyles.experimentDescription}
                    />

                    {/* Global Tooltip for Task Description */}
                    {showTooltip && tooltipContent && (
                        <div
                            style={{ top: tooltipPosition.y, left: tooltipPosition.x }}
                            className={`fixed p-2 rounded-lg shadow-lg
                                ${appData.darkMode ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-800'}
                                transition-opacity duration-300 z-50 whitespace-pre-wrap text-xs
                                min-w-[150px] max-w-[250px] transform -translate-y-1/2`}
                        >
                            {tooltipContent}
                        </div>
                    )}
                </div>
            );
        };

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
